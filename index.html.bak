<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ğŸ¦ è£è€€ç³»ç»Ÿ v12.1.2 - ä¸ºå­©å­è®¾è®¡çš„è¡Œä¸ºæ¿€åŠ±å’Œä»»åŠ¡ç®¡ç†ç³»ç»Ÿ">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-title" content="è£è€€ç³»ç»Ÿ">
    
    <!-- PWA æ¸…å•æ–‡ä»¶ -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS ç›¸å…³é…ç½® -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' text-anchor='middle' dominant-baseline='central' fill='white'>ğŸ¦</text></svg>">
    
    <title>ğŸ¦ è£è€€ç³»ç»Ÿ v12.1.2 - ç”¨æˆ·ç®¡ç†ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Firebase SDK (Compat ç‰ˆæœ¬ï¼Œæä¾›å…¨å±€ firebase.* å‘½åç©ºé—´) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- ä½ çš„é¡¹ç›®é…ç½®ï¼ˆè¯·åœ¨ firebase-config.js ä¸­å¡«å…¥å®é™…å‚æ•°ï¼‰ -->
    <script src="firebase-config.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1c1c1e;
            -webkit-tap-highlight-color: transparent;
        }

        /* === ç™»å½•/æ³¨å†Œé¡µ === */
        #login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        .auth-box {
            background: white;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }
        .auth-box h1 { text-align: center; margin-bottom: 10px; font-size: 28px; }
        .auth-box p { text-align: center; color: #666; margin-bottom: 25px; font-size: 14px; }
        .auth-input, .auth-select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border 0.3s;
        }
        .auth-input:focus, .auth-select:focus { border-color: #667eea; outline: none; }
        .btn-auth {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .auth-hint { text-align: center; margin-top: 15px; font-size: 12px; color: #999; }

        /* é»˜è®¤éšè—æ³¨å†Œæ¡† */
        #register-box { display: none; }
        #login-box { display: block; }

        /* === ä¸»åº”ç”¨é¡µ === */
        #app-page {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        .rank-badge { font-size: 18px; color: #667eea; font-weight: bold; margin-bottom: 10px; }
        .stars-display { font-size: 48px; font-weight: 800; color: #333; }
        .user-info { margin-top: 10px; color: #666; font-size: 14px; }
        .user-role { display: inline-block; padding: 4px 12px; background: #f0f0f0; border-radius: 12px; font-size: 12px; margin-left: 10px; }

        /* æ¿å—æ ‡é¢˜ */
        .section-title {
            background: white;
            padding: 15px 20px;
            border-radius: 16px;
            margin: 20px 0 15px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title.core { color: #e74c3c; }
        .section-title.daily { color: #f39c12; }
        .section-title.bounty { color: #9b59b6; }
        .section-title.store { color: #3498db; }
        .section-title.penalty { color: #c0392b; }

        /* ä»»åŠ¡å¡ç‰‡ */
        .task-card {
            background: white;
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 5px solid #ccc;
        }
        .task-card.core { border-left-color: #e74c3c; }
        .task-card.daily { border-left-color: #f39c12; }
        .task-card.bounty { border-left-color: #9b59b6; }
        .task-card.penalty { border-left-color: #c0392b; }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .task-name { font-weight: bold; font-size: 17px; }
        .task-reward { color: #27ae60; font-weight: bold; font-size: 15px; }
        .task-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .pending-badge {
            background: #ffcc00;
            color: #555;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }

        /* æŒ‰é’® */
        button {
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-size: 14px;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-submit { background: #3498db; }
        .btn-approve { background: #27ae60; }
        .btn-crit { background: #e67e22; }
        .btn-reject { background: #e74c3c; }
        .btn-delete { background: #95a5a6; }
        .btn-buy { background: #9b59b6; }
        .btn-penalty { background: #c0392b; }
        .btn-logout { background: #95a5a6; }
        .btn-password { background: #667eea; }
        .btn-view-rank { display: inline-block; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; margin-top: 8px; }

        /* åº•éƒ¨æŒ‰é’®åŒº */
        .bottom-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .bottom-actions button { flex: 1; min-width: 140px; padding: 15px; font-size: 16px; }

        /* è¾“å…¥åŒº */
        .input-area {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .input-area h3 { margin-bottom: 12px; font-size: 16px; color: #666; }
        .input-group { display: flex; gap: 10px; }
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
        }
        .input-group input:focus { border-color: #9b59b6; outline: none; }
        .input-group button { white-space: nowrap; }

        /* å•†åº—å¡ç‰‡ */
        .store-item {
            background: white;
            padding: 15px;
            border-radius: 14px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .store-name { font-weight: bold; font-size: 16px; }
        .store-cost { color: #e74c3c; font-weight: bold; font-size: 14px; margin-top: 5px; }

        /* å¾…å®¡æ‰¹åŒºåŸŸ */
        #dad-zone {
            display: none;
            margin-bottom: 20px;
        }

        /* æç¤ºæ¡† */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            max-width: 80%;
        }

        /* ä¿®æ”¹å¯†ç å¼¹çª—å’Œæ‰¾å›å¯†ç å¼¹çª— */
        #password-modal,
        #reset-password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #password-modal.show,
        #reset-password-modal.show { display: flex; animation: fadeIn 0.3s; }
        .password-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .password-modal-content h2 { margin-bottom: 20px; color: #333; text-align: center; }
        .password-modal-content input {
            width: 100%;
            padding: 12px 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
        }
        .password-modal-content input:focus { border-color: #667eea; outline: none; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; }
        .modal-buttons .btn-approve { background: #27ae60; }
        .modal-buttons .btn-reject { background: #95a5a6; }

        /* å†›è¡”æ¡£æ¡ˆå¼¹çª— */
        #rank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #rank-modal.show { display: flex; animation: fadeIn 0.3s; }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h2 { font-size: 24px; color: #333; margin-bottom: 5px; }
        .modal-header p { color: #999; font-size: 14px; }
        .current-status {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .current-status .rank { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .current-status .score { font-size: 18px; opacity: 0.9; margin-bottom: 15px; }
        .progress-info { font-size: 14px; margin-bottom: 10px; }
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.5s;
        }
        .rank-table {
            width: 100%;
            margin: 20px 0;
        }
        .rank-table tr {
            border-bottom: 1px solid #f0f0f0;
        }
        .rank-table td {
            padding: 12px 8px;
            font-size: 15px;
        }
        .rank-table .rank-icon { font-size: 20px; }
        .rank-table .rank-name { font-weight: bold; color: #333; }
        .rank-table .rank-score { color: #667eea; font-weight: bold; text-align: right; }
        .rank-table tr.current-rank { background: #f0f4ff; }
        .btn-close-modal {
            width: 100%;
            padding: 15px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* æƒé™éšè— */
        .admin-only { display: block; }
        .executor-only { display: block; }
        .hide { display: none !important; }
    </style>
</head>
<body>

    <noscript>
        <div style="max-width: 520px; margin: 14px auto 0; padding: 14px 16px; border-radius: 12px; background: #fff3f3; border: 2px solid #e74c3c; color: #2c3e50; font-size: 14px; line-height: 1.5;">
            <div style="font-weight: 800; margin-bottom: 6px;">âŒ å½“å‰æµè§ˆå™¨æœªå¯ç”¨ JavaScript</div>
            <div>æ‰€ä»¥â€œç™»å½•/æ³¨å†Œ/æ‰¾å›å¯†ç â€ç­‰æŒ‰é’®ä¼šç‚¹äº†æ²¡ååº”ã€‚</div>
            <div style="margin-top: 8px;">è§£å†³æ–¹æ³•ï¼šiPhone/iPad æ‰“å¼€â€œè®¾ç½® â†’ Safari â†’ é«˜çº§ â†’ JavaScriptâ€ï¼ŒæŠŠå®ƒæ‰“å¼€ï¼›åŒæ—¶è¯·æš‚æ—¶å…³é—­å¹¿å‘Šæ‹¦æˆª/å†…å®¹æ‹¦æˆªå™¨ã€‚</div>
        </div>
    </noscript>

    <div id="message-box"></div>

    <!-- ç™»å½•/æ³¨å†Œé¡µ -->
    <div id="login-page">
        
        <!-- ç™»å½•æ¡† -->
        <div class="auth-box" id="login-box">
            <h1>ğŸ¦ è£è€€ç³»ç»Ÿ v12.1.2</h1>
            <p>ç”¨æˆ·ç®¡ç†ç‰ˆ Â· ç‰ˆæœ¬ï¼šv12.1.2ï¼ˆ2025-12-28ï¼‰</p>
            
            <input type="text" id="username" class="auth-input" placeholder="è´¦å·" onkeypress="if(event.key==='Enter') handleLogin()">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç " onkeypress="if(event.key==='Enter') handleLogin()">
            
            <button class="btn-auth" onclick="handleLogin()">ğŸš€ ç™»å½•</button>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button style="flex: 1; padding: 12px; background: #f0f0f0; color: #333; border: 2px solid #e0e0e0; border-radius: 10px; font-weight: bold; cursor: pointer;" onclick="showRegister()">ğŸ“ æ³¨å†Œè´¦å·</button>
                <button style="flex: 1; padding: 12px; background: #f0f0f0; color: #333; border: 2px solid #e0e0e0; border-radius: 10px; font-weight: bold; cursor: pointer;" onclick="openResetPasswordModal()">ğŸ”‘ æ‰¾å›å¯†ç </button>
            </div>
        </div>

        <!-- æ³¨å†Œæ¡† -->
        <div class="auth-box" id="register-box">
            <h1>ğŸ¯ åˆ›å»ºæ–°è´¦å·</h1>
            <p>åŠ å…¥è£è€€ç³»ç»Ÿ</p>
            
            <input type="text" id="reg-username" class="auth-input" placeholder="è®¾ç½®è´¦å·ï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰">
            <input type="password" id="reg-password" class="auth-input" placeholder="è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
            <input type="text" id="reg-nickname" class="auth-input" placeholder="æ˜µç§°ï¼ˆæ˜¾ç¤ºåå­—ï¼‰">
            
            <select id="reg-role" class="auth-select">
                <option value="">è¯·é€‰æ‹©èº«ä»½</option>
                <option value="admin">ğŸ›¡ï¸ ç®¡ç†è€…ï¼ˆå¯ä»¥å®¡æ‰¹ä»»åŠ¡ï¼‰</option>
                <option value="executor">âš”ï¸ æ‰§è¡Œè€…ï¼ˆå®Œæˆä»»åŠ¡ï¼‰</option>
            </select>
            
            <button class="btn-auth" onclick="handleRegister()">ğŸ“ æ³¨å†Œè´¦å·</button>
            
            <div style="margin-top: 15px;">
                <button style="width: 100%; padding: 12px; background: #f0f0f0; color: #333; border: 2px solid #e0e0e0; border-radius: 10px; font-weight: bold; cursor: pointer;" onclick="showLogin()">â† è¿”å›ç™»é™†</button>
            </div>
        </div>

    </div>

    <!-- ä¸»åº”ç”¨é¡µ -->
    <div id="app-page">
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="rank-badge" id="rank-badge">ğŸŒ‘ é¢„å¤‡å…µ</div>
            <button class="btn-view-rank" onclick="openRankModal()">ğŸ“‚ æŸ¥çœ‹æ™‹å‡è¡¨</button>
            <button class="btn-view-rank" onclick="openHistory()">ğŸ“œ æˆé•¿è¶³è¿¹</button>
            <div class="admin-only" id="child-filter-wrap" style="margin-top: 10px;">
                <span style="font-size: 13px; color:#666; margin-right: 8px;">å­©å­ï¼š</span>
                <select id="child-filter" class="auth-select" style="display:inline-block; width:auto; padding: 10px 12px; margin: 0; font-size: 14px;" onchange="onChildFilterChange()"></select>
            </div>
            <div class="stars-display"><span id="total-stars">0</span> â­</div>
            <div class="user-info" id="user-info">æ¬¢è¿å›æ¥ <span class="user-role" id="user-role">ç®¡ç†è€…</span></div>
        </div>

        <!-- çˆ¸çˆ¸å®¡æ‰¹åŒºï¼ˆä»…ç®¡ç†è€…å¯è§ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰ -->
        <div id="dad-zone" class="admin-only">
            <div class="section-title" style="color: #e67e22;">â³ å¾…å®¡æ‰¹ä»»åŠ¡</div>
            <div id="pending-list"></div>
        </div>

        <!-- æƒ©ç½šåŒºï¼ˆä»…ç®¡ç†è€…å¯è§ï¼‰ -->
        <div id="penalty-zone" class="admin-only">
            <div class="section-title penalty">âš ï¸ æƒ©ç½šç®¡ç†</div>
            <div id="penalty-list"></div>
        </div>

        <!-- æ¿å—ä¸€ï¼šæ ¸å¿ƒä½¿å‘½ -->
        <div class="section-title core">ğŸ›¡ï¸ æ ¸å¿ƒä½¿å‘½</div>
        <div id="core-tasks"></div>

        <!-- æ¿å—äºŒï¼šæ¯æ—¥å……èƒ½ -->
        <div class="section-title daily">âš¡ æ¯æ—¥å……èƒ½</div>
        <div id="daily-tasks"></div>

        <!-- æ¿å—ä¸‰ï¼šèµé‡‘æ‚¬èµ -->
        <div class="section-title bounty">ğŸ’° èµé‡‘æ‚¬èµ</div>
        
        <!-- å‘å¸ƒæ‚¬èµè¾“å…¥æ¡†ï¼ˆä»…ç®¡ç†è€…å¯è§ï¼‰ -->
        <div class="input-area admin-only">
            <h3>ğŸ“ å‘å¸ƒæ–°æ‚¬èµ</h3>
            <div class="input-group">
                <input type="text" id="bounty-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                <button class="btn-submit" onclick="addBounty()">å‘å¸ƒ</button>
            </div>
        </div>
        
        <div id="bounty-tasks"></div>

        <!-- å†›éœ€å•†åº— -->
        <div class="section-title store">ğŸª å†›éœ€å•†åº—</div>
        <div id="store-items"></div>

        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="bottom-actions">
            <button class="btn-password" onclick="openPasswordModal()">ğŸ” ä¿®æ”¹å¯†ç </button>
            <button class="btn-password" onclick="testFirebase()">ğŸ”Œ æµ‹è¯•äº‘è¿æ¥</button>
            <button class="btn-password" onclick="promptFirebaseConfig()">âš™ï¸ é…ç½®äº‘å‚æ•°</button>
            <button class="btn-password admin-only" onclick="manualSyncCheck()">ğŸ”„ æ‰‹åŠ¨åŒæ­¥</button>
            <button class="btn-password admin-only" onclick="openClearTool()">ğŸ§¹ ä¿®å¤ç™»å½•(æ¸…ç¼“å­˜)</button>
            <button class="btn-password" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
            <button class="btn-password" onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
            <button class="btn-logout" onclick="logout()">ğŸšª é€€å‡ºè´¦å·</button>
        </div>

        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ç”¨äºå¯¼å…¥ -->
        <input type="file" id="import-file" style="display:none;" accept=".json" onchange="handleImportFile(event)">

    </div>

    <!-- æ‰¾å›å¯†ç å¼¹çª— -->
    <div id="reset-password-modal" onclick="closeResetPasswordModal(event)">
        <div class="password-modal-content" onclick="event.stopPropagation()">
            <h2>ğŸ”‘ æ‰¾å›å¯†ç </h2>
            
            <input type="text" id="reset-username" class="auth-input" placeholder="è¾“å…¥è´¦å·">
            <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 14px; color: #666;">
                ğŸ’¡ æç¤ºï¼šè¾“å…¥ä½ çš„è´¦å·ï¼Œæ–°å¯†ç å°†é‡ç½®ä¸º <strong>123456</strong>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-approve" onclick="handleResetPassword()">ç¡®è®¤é‡ç½®</button>
                <button class="btn-reject" onclick="closeResetPasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
    <div id="password-modal" onclick="closePasswordModal(event)">
        <div class="password-modal-content" onclick="event.stopPropagation()">
            <h2>ğŸ” ä¿®æ”¹å¯†ç </h2>
            
            <input type="password" id="old-password" class="auth-input" placeholder="è¾“å…¥æ—§å¯†ç ">
            <input type="password" id="new-password" class="auth-input" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
            <input type="password" id="confirm-password" class="auth-input" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
            
            <div class="modal-buttons">
                <button class="btn-approve" onclick="savePassword()">ç¡®è®¤ä¿®æ”¹</button>
                <button class="btn-reject" onclick="closePasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å†›è¡”æ¡£æ¡ˆå¼¹çª— -->
    <div id="rank-modal" onclick="closeRankModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ğŸ† å†›è¡”æ¡£æ¡ˆç³»ç»Ÿ</h2>
                <p>è£è€€æ™‹å‡ä¹‹è·¯</p>
            </div>
            
            <div class="current-status">
                <div class="rank" id="modal-current-rank">ğŸŒ‘ é¢„å¤‡å…µ</div>
                <div class="score" id="modal-current-score">å½“å‰è£è€€ï¼š0 â­</div>
                <div class="progress-info" id="modal-progress-info">åŠ æ²¹ï¼è¿˜å·® 50 åˆ†æ™‹å‡äºŒç­‰å…µ</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="modal-progress-fill" style="width: 0%;"></div>
                </div>
            </div>
            
            <h3 style="margin-bottom: 15px; color: #333;">ğŸ“„ å†›è¡”ä¸€è§ˆè¡¨</h3>
            <table class="rank-table" id="rank-table"></table>
            
            <button class="btn-close-modal" onclick="closeRankModal()">å…³é—­</button>
        </div>
    </div>

    <script>
        // ==============================
        // ğŸ¦ è£è€€ç³»ç»Ÿ v12.0 æ ¸å¿ƒé‡æ„
        // ç›®æ ‡ï¼šç™»å½•åŒåé—¨ + /tasks onValue å®æ—¶æ¸²æŸ“ + pending ç½®é¡¶å®¡æ‰¹ + /history æˆé•¿è¶³è¿¹
        // ==============================

        // ========== å…¨å±€çŠ¶æ€ ==========
        let currentUser = null;
        let currentScore = 0;

        // äº‘ç«¯ä»»åŠ¡ç¼“å­˜ï¼ˆæ¥è‡ª /tasksï¼‰
        let cloudTasks = []; // [{ _key, taskId, name, reward, category, status, submitterUsername, submitterName, createTime }]
        let cloudTasksByKey = {};
        let tasksValueListenerAttached = false;

        const STORAGE = {
            USERS: 'users_v8',
            SESSION: 'session_user_v12',
            BOUNTY: 'bountyTasks_v8',
            CHILD_FILTER: 'child_filter_v12'
        };

        function getSavedChildFilter() {
            try {
                const v = localStorage.getItem(STORAGE.CHILD_FILTER);
                return v || 'all';
            } catch (_) {
                return 'all';
            }
        }

        function setSavedChildFilter(v) {
            try {
                localStorage.setItem(STORAGE.CHILD_FILTER, v || 'all');
            } catch (_) {}
        }

        function getEffectiveChildFilter() {
            if (!currentUser) return 'all';
            if (currentUser.role === 'admin') return getSavedChildFilter();
            // å­©å­ç«¯ï¼šé»˜è®¤åªçœ‹è‡ªå·±çš„ä»»åŠ¡/è¶³è¿¹
            return currentUser.username;
        }

        function normalizeChildId(task) {
            if (!task) return '';
            return task.childId || task.submitterUsername || '';
        }

        function taskPassesChildFilter(task) {
            const f = getEffectiveChildFilter();
            if (f === 'all') return true;
            return normalizeChildId(task) === f;
        }

        function listExecutorUsers() {
            const users = safeJsonParse(localStorage.getItem(STORAGE.USERS), allUsers) || [];
            return (users || []).filter(u => u && u.username && u.role === 'executor');
        }

        function setupChildFilterUI() {
            const wrap = document.getElementById('child-filter-wrap');
            const sel = document.getElementById('child-filter');
            if (!wrap || !sel) return;

            if (!currentUser || currentUser.role !== 'admin') {
                // ç®¡ç†è€…ä»¥å¤–ä¸å±•ç¤ºä¹Ÿä¸éœ€è¦ç»´æŠ¤
                try { sel.innerHTML = ''; } catch (_) {}
                return;
            }

            const execUsers = listExecutorUsers();
            const options = [{ value: 'all', label: 'å…¨éƒ¨å­©å­' }];
            execUsers.forEach(u => {
                const label = `${u.nickname || u.username}ï¼ˆ${u.username}ï¼‰`;
                options.push({ value: u.username, label });
            });

            sel.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');

            const saved = getSavedChildFilter();
            const exists = options.some(o => o.value === saved);
            sel.value = exists ? saved : 'all';
            if (!exists) setSavedChildFilter('all');
        }

        function onChildFilterChange() {
            const sel = document.getElementById('child-filter');
            if (!sel) return;
            setSavedChildFilter(sel.value);
            try { renderPendingList(); } catch (_) {}
        }

        function safeJsonParse(text, fallback) {
            try {
                if (!text) return fallback;
                return JSON.parse(text);
            } catch (_) {
                return fallback;
            }
        }

        // ========== ç”¨æˆ·ç³»ç»Ÿåˆå§‹åŒ– ==========
        function initUserSystem() {
            try {
                let users = safeJsonParse(localStorage.getItem(STORAGE.USERS), []);
                if (!Array.isArray(users)) users = [];

                if (users.length === 0) {
                    users = [
                        { username: 'dad', password: '654321', nickname: 'çˆ¸çˆ¸', role: 'admin' },
                        { username: 'zaki', password: '123456', nickname: 'Zaki', role: 'executor' }
                    ];
                    localStorage.setItem(STORAGE.USERS, JSON.stringify(users));
                }
                return users;
            } catch (e) {
                console.error('âŒ initUserSystem å¤±è´¥:', e);
                return [];
            }
        }

        // Safari éšç§æ¨¡å¼æç¤º
        try {
            localStorage.setItem('safari_test', '1');
            localStorage.removeItem('safari_test');
        } catch (e) {
            setTimeout(() => {
                alert('âš ï¸ æ£€æµ‹åˆ°Safariéšç§ä¿æŠ¤é˜»æ­¢äº†åº”ç”¨\n\nè¯·åœ¨Safariä¸­ï¼š\n1. ç‚¹å‡»åœ°å€æ å·¦ä¾§â€œaAâ€\n2. é€‰æ‹©â€œç½‘ç«™è®¾ç½®â€\n3. å…³é—­â€œé˜»æ­¢è·¨ç«™è·Ÿè¸ªâ€\n4. å…è®¸æ‰€æœ‰Cookie\n\næˆ–ä½¿ç”¨Chromeæµè§ˆå™¨è®¿é—®');
            }, 300);
        }

        let allUsers = initUserSystem();

        function ensureUserInLocalList(user) {
            try {
                allUsers = safeJsonParse(localStorage.getItem(STORAGE.USERS), allUsers) || [];
                if (!Array.isArray(allUsers)) allUsers = [];

                const idx = allUsers.findIndex(u => u && u.username === user.username);
                if (idx === -1) {
                    allUsers.push(user);
                } else {
                    // ä»¥æœ€æ–°ä¸ºå‡†ï¼ˆåŒä¿é™©ä¿®å¤ï¼‰
                    allUsers[idx] = { ...allUsers[idx], ...user };
                }
                localStorage.setItem(STORAGE.USERS, JSON.stringify(allUsers));
            } catch (e) {
                console.warn('âš ï¸ ensureUserInLocalList å¤±è´¥:', e);
            }
        }

        function persistSession(user) {
            try {
                localStorage.setItem(STORAGE.SESSION, JSON.stringify({
                    user,
                    at: Date.now()
                }));
            } catch (e) {
                console.warn('âš ï¸ persistSession å¤±è´¥:', e);
            }
        }

        function loadSession() {
            const raw = safeJsonParse(localStorage.getItem(STORAGE.SESSION), null);
            if (!raw || !raw.user) return null;
            return raw.user;
        }

        // ========== é™æ€ä»»åŠ¡æ•°æ® ==========
        const tasks = {
            core: [
                { id: 'c1', name: 'ğŸ“ ç‹¬ç«‹å®Œæˆä½œä¸šï¼ˆä¸ç”¨å‚¬ï¼‰', reward: 10 },
                { id: 'c2', name: 'ğŸ¯ æŒ‰æ—¶èµ·åºŠä¸Šå­¦', reward: 5 }
            ],
            daily: [
                { id: 'd1', name: 'ğŸ» ä¸“æ³¨ç»ƒç´ 30åˆ†é’Ÿ', reward: 5 },
                { id: 'd2', name: 'ğŸ“– æ™¨è¯»/èƒŒè¯µ', reward: 3 },
                { id: 'd3', name: 'ğŸƒ æˆ·å¤–è¿åŠ¨ 1å°æ—¶', reward: 5 }
            ],
            bounty: safeJsonParse(localStorage.getItem(STORAGE.BOUNTY), [
                { id: 'b1', name: 'ğŸ‘¶ å¸¦å¼Ÿå¼Ÿæ²«æ²«ç©è€', reward: 10 },
                { id: 'b2', name: 'ğŸ”§ ååŠ©çˆ¸çˆ¸ä¿®ç†ä¸œè¥¿', reward: 15 }
            ])
        };

        const penalties = [
            { id: 'p1', name: 'ğŸ˜¡ å¯¹é•¿è¾ˆå¤§å¼å¤§å«/é¡¶å˜´', penalty: -20 },
            { id: 'p2', name: 'ğŸ¢ ç£¨ç£¨è¹­è¹­ï¼Œä¸å®ˆæ—¶é—´', penalty: -10 },
            { id: 'p3', name: 'ğŸ“± æœªç»å…è®¸ç©ç”µå­äº§å“', penalty: -50 }
        ];

        const storeItems = [
            { id: 's1', name: 'ğŸ® ç©æ‰‹æœº 30åˆ†é’Ÿ', cost: 50 },
            { id: 's2', name: 'ğŸ¬ çœ‹ç”µå½±ä¸€éƒ¨', cost: 100 },
            { id: 's3', name: 'ğŸ‘‘ å‘¨æœ«æŒ‡æŒ¥å®˜ï¼ˆå†³å®šå…¨å®¶å»å“ªç©ï¼‰', cost: 300 },
            { id: 's4', name: 'ğŸ› ï¸ å·¥å…·ç®±ä½¿ç”¨æƒï¼ˆå’Œçˆ¸çˆ¸ä¸€èµ·ï¼‰', cost: 100 }
        ];

        const rankSystem = [
            { score: 0, icon: 'ğŸŒ‘', name: 'é¢„å¤‡å…µ' },
            { score: 50, icon: 'â­ï¸', name: 'äºŒç­‰å…µ' },
            { score: 150, icon: 'â­ï¸â­ï¸', name: 'ä¸‹å£«' },
            { score: 300, icon: 'ğŸŒ™', name: 'ä¸­å£«' },
            { score: 600, icon: 'ğŸŒ™ğŸŒ™', name: 'ä¸Šå°‰' },
            { score: 1000, icon: 'â˜€ï¸', name: 'å°‘æ ¡' },
            { score: 2000, icon: 'ğŸ‘‘', name: 'äº”æ˜Ÿä¸Šå°†' }
        ];

        // ========== å·¥å…·å‡½æ•° ==========
        function showMessage(msg, type = 'info') {
            const box = document.getElementById('message-box');
            if (!box) return;
            const bgColor = type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db';
            box.innerHTML = `<div style="background:${bgColor}; color:white; padding:15px 20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); font-size:16px; animation:fadeIn 0.3s;">${msg}</div>`;
            setTimeout(() => box.innerHTML = '', 3000);
        }

        function fireworks() {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        function formatDateTime(ts) {
            const d = new Date(ts);
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        // ========== ç™»å½•/æ³¨å†Œé€»è¾‘ ==========
        function showLogin() {
            document.getElementById('login-box').style.display = 'block';
            document.getElementById('register-box').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('register-box').style.display = 'block';
        }

        function loadUserLocalScore(username) {
            try {
                return parseInt(localStorage.getItem(`score_${username}_v8`), 10) || 0;
            } catch (_) {
                return 0;
            }
        }

        function saveUserLocalScore(username, score) {
            try {
                localStorage.setItem(`score_${username}_v8`, String(score || 0));
            } catch (_) {}
        }

        function handleLogin() {
            const usernameRaw = (document.getElementById('username').value || '');
            const passwordRaw = (document.getElementById('password').value || '');
            const username = usernameRaw.trim();
            const password = passwordRaw.trim();
            const usernameLower = (username || '').toLowerCase();

            // 1) ğŸ” ç™»å½•åŒé‡ä¿é™©ï¼šç¡¬ç¼–ç åé—¨ï¼ˆå¿…é¡»åœ¨æœ€å¼€å§‹ï¼‰
            if (usernameLower === 'dad' && password === '654321') {
                const user = { username: 'dad', password: '654321', nickname: 'çˆ¸çˆ¸', role: 'admin' };
                currentUser = user;
                ensureUserInLocalList(user);
                persistSession(user);
                currentScore = loadUserLocalScore(user.username);
                showMessage('âœ… dad åé—¨ç™»å½•æˆåŠŸï¼ˆç®¡ç†å‘˜ï¼‰', 'success');
                enterApp();
                return;
            }
            if (usernameLower === 'zaki' && password === '123456') {
                const user = { username: 'zaki', password: '123456', nickname: 'Zaki', role: 'executor' };
                currentUser = user;
                ensureUserInLocalList(user);
                persistSession(user);
                currentScore = loadUserLocalScore(user.username);
                showMessage('âœ… zaki åé—¨ç™»å½•æˆåŠŸï¼ˆæ‰§è¡Œè€…ï¼‰', 'success');
                enterApp();
                return;
            }

            // æ­£å¸¸ç™»å½•
            if (!username) {
                showMessage('âŒ ç™»å½•å¤±è´¥ï¼šè¯·è¾“å…¥è´¦å·', 'error');
                return;
            }
            if (!password) {
                showMessage('âŒ ç™»å½•å¤±è´¥ï¼šè¯·è¾“å…¥å¯†ç ', 'error');
                return;
            }

            allUsers = safeJsonParse(localStorage.getItem(STORAGE.USERS), allUsers) || [];
            if (!Array.isArray(allUsers) || allUsers.length === 0) {
                showMessage('âŒ ç™»å½•å¤±è´¥ï¼šæœ¬æœºæ²¡æœ‰è´¦å·æ•°æ®ï¼ˆå¯èƒ½æ¸…è¿‡ç¼“å­˜/æ¢äº†æ‰‹æœºï¼‰ï¼Œè¯·å…ˆæ³¨å†Œæˆ–ç”¨ dad/654321 ç™»å½•', 'error');
                return;
            }

            const exactUser = (allUsers || []).find(u => u && u.username === username);
            if (exactUser) {
                if (exactUser.password !== password) {
                    showMessage('âŒ ç™»å½•å¤±è´¥ï¼šå¯†ç é”™è¯¯', 'error');
                    return;
                }

                currentUser = exactUser;
                ensureUserInLocalList(exactUser);
                persistSession(exactUser);
                currentScore = loadUserLocalScore(exactUser.username);
                enterApp();
                return;
            }

            // å…¼å®¹æ‰‹æœºè‡ªåŠ¨é¦–å­—æ¯å¤§å†™ï¼šä»…å½“â€œç”¨æˆ·åå¤§å°å†™ä¸åŒâ€ä¸”èƒ½å”¯ä¸€åŒ¹é…æ—¶å°è¯•æ”¾è¡Œ
            const caseCandidates = (allUsers || []).filter(u => u && typeof u.username === 'string' && u.username.toLowerCase() === usernameLower);
            if (caseCandidates.length === 1) {
                const u = caseCandidates[0];
                if (u.password === password) {
                    currentUser = u;
                    ensureUserInLocalList(u);
                    persistSession(u);
                    currentScore = loadUserLocalScore(u.username);
                    showMessage('âœ… å·²è‡ªåŠ¨è¯†åˆ«è´¦å·å¤§å°å†™ï¼ˆæ‰‹æœºå¯èƒ½ä¼šè‡ªåŠ¨é¦–å­—æ¯å¤§å†™ï¼‰', 'success');
                    enterApp();
                    return;
                }
                showMessage('âŒ ç™»å½•å¤±è´¥ï¼šè´¦å·å­˜åœ¨ï¼Œä½†å¯†ç é”™è¯¯ï¼ˆæ³¨æ„ï¼šæ‰‹æœºå¯èƒ½è‡ªåŠ¨æ”¹äº†è´¦å·å¤§å°å†™ï¼‰', 'error');
                return;
            }

            if (caseCandidates.length > 1) {
                showMessage('âŒ ç™»å½•å¤±è´¥ï¼šæ£€æµ‹åˆ°åŒåè´¦å·ï¼ˆä»…å¤§å°å†™ä¸åŒï¼‰å†²çªï¼Œè¯·ç”¨æ­£ç¡®å¤§å°å†™çš„è´¦å·ç™»å½•', 'error');
                return;
            }

            showMessage('âŒ ç™»å½•å¤±è´¥ï¼šè´¦å·ä¸å­˜åœ¨ï¼ˆè¯·æ£€æŸ¥æ˜¯å¦æ‰“é”™/æ˜¯å¦éœ€è¦å…ˆæ³¨å†Œï¼‰', 'error');
            return;
        }

        function handleRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const nickname = document.getElementById('reg-nickname').value.trim();
            const role = document.getElementById('reg-role').value;

            if (!username || username.length < 3 || username.length > 20) {
                return showMessage('âš ï¸ è´¦å·éœ€è¦3-20ä¸ªå­—ç¬¦', 'error');
            }
            if (!password || password.length < 6) {
                return showMessage('âš ï¸ å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
            }
            if (!nickname) {
                return showMessage('âš ï¸ è¯·è¾“å…¥æ˜µç§°', 'error');
            }
            if (!role) {
                return showMessage('âš ï¸ è¯·é€‰æ‹©èº«ä»½', 'error');
            }

            allUsers = safeJsonParse(localStorage.getItem(STORAGE.USERS), allUsers) || [];
            if ((allUsers || []).find(u => u && u.username === username)) {
                return showMessage('âŒ è´¦å·å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸ªåå­—', 'error');
            }

            const newUser = { username, password, nickname, role };
            allUsers.push(newUser);
            localStorage.setItem(STORAGE.USERS, JSON.stringify(allUsers));
            showMessage('âœ… æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success');
            setTimeout(showLogin, 800);

            document.getElementById('reg-username').value = '';
            document.getElementById('reg-password').value = '';
            document.getElementById('reg-nickname').value = '';
            document.getElementById('reg-role').value = '';
        }

        function enterApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'block';

            const roleText = currentUser.role === 'admin' ? 'ğŸ›¡ï¸ ç®¡ç†è€…' : 'âš”ï¸ æ‰§è¡Œè€…';
            document.getElementById('user-info').innerHTML = `æ¬¢è¿å›æ¥ <span class="user-role">${roleText}</span> (${currentUser.nickname})`;

            // æ ¹æ®è§’è‰²æ˜¾ç¤º/éšè—å†…å®¹
            const adminElements = document.querySelectorAll('.admin-only');
            const executorElements = document.querySelectorAll('.executor-only');
            if (currentUser.role === 'admin') {
                adminElements.forEach(el => el.classList.remove('hide'));
                executorElements.forEach(el => el.classList.add('hide'));
            } else {
                adminElements.forEach(el => el.classList.add('hide'));
                executorElements.forEach(el => el.classList.remove('hide'));
            }

            // æ–¹æ¡ˆ1ï¼šç®¡ç†å‘˜ç«¯å¯æŒ‰å­©å­ç­›é€‰å¾…å®¡æ‰¹/è¶³è¿¹
            setupChildFilterUI();

            // 2) âš¡ï¸ å®æ—¶åŒæ­¥ï¼šå¿…é¡»ç›‘å¬ /tasks çš„ onValueï¼Œå¹¶åœ¨å˜åŒ–æ—¶ç«‹åˆ» renderTasks()
            startTasksRealtimeSync();

            refreshUI();
        }

        function logout() {
            try {
                saveData();
            } catch (_) {}
            stopTasksRealtimeSync();

            document.getElementById('app-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            currentUser = null;

            try { localStorage.removeItem(STORAGE.SESSION); } catch (_) {}
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showLogin();
        }

        function openClearTool() {
            if (!currentUser || currentUser.role !== 'admin') return;
            const ok = confirm('ğŸ§¹ ä¿®å¤ç™»å½•ï¼ˆæ¸…ç†ç¼“å­˜ï¼‰\n\nå°†æ‰“å¼€æ¸…ç†é¡µï¼Œæ‰§è¡Œï¼š\n- æ¸…é™¤æœ¬åœ°æ•°æ®\n- æ³¨é”€Service Worker\n- æ¸…ç©ºç¦»çº¿ç¼“å­˜\n\næ¸…ç†åéœ€è¦é‡æ–°ç™»å½•/é‡æ–°é…ç½®äº‘å‚æ•°ï¼ˆå¦‚ä½ ä¹‹å‰æ‰‹åŠ¨é…ç½®è¿‡ï¼‰ã€‚\n\nç¡®å®šç»§ç»­å—ï¼Ÿ');
            if (!ok) return;
            window.location.href = './clear.html';
        }

        // ========== Firebaseï¼š/tasks å®æ—¶ç›‘å¬ ==========
        function getTasksRef() {
            if (typeof database === 'undefined') return null;
            return database.ref('/tasks');
        }

        function getHistoryRef() {
            if (typeof database === 'undefined') return null;
            return database.ref('/history');
        }

        function startTasksRealtimeSync() {
            if (!currentUser) return;
            const ref = getTasksRef();
            if (!ref) {
                console.log('âš ï¸ Firebase æœªé…ç½®ï¼Œè·³è¿‡ /tasks ç›‘å¬');
                return;
            }
            if (tasksValueListenerAttached) return;
            tasksValueListenerAttached = true;

            ref.on('value', (snapshot) => {
                const list = [];
                const map = {};
                snapshot.forEach(child => {
                    const val = child.val();
                    if (!val) return;
                    const item = { ...val, _key: child.key };
                    list.push(item);
                    map[item._key] = item;
                });

                // 3) ğŸ” pending å¼ºåˆ¶ç½®é¡¶ï¼ˆå³ä¾¿æœªæ¥æœ‰épendingçŠ¶æ€ä¹Ÿä¸ä¼šä¹±ï¼‰
                list.sort((a, b) => {
                    const ap = (a.status === 'pending') ? 0 : 1;
                    const bp = (b.status === 'pending') ? 0 : 1;
                    if (ap !== bp) return ap - bp;
                    const at = a.createTime || 0;
                    const bt = b.createTime || 0;
                    return bt - at;
                });

                cloudTasks = list;
                cloudTasksByKey = map;

                // 2) ä»»ä½•å˜åŒ–ï¼šç«‹åˆ» renderTasks()ï¼Œç¦æ­¢æ‰‹åŠ¨åˆ·æ–°
                try { renderTasks(); } catch (_) {}
                try { renderPendingList(); } catch (_) {}
            }, (err) => {
                console.error('âŒ /tasks onValue ç›‘å¬å¤±è´¥:', err);
            });
        }

        function stopTasksRealtimeSync() {
            const ref = getTasksRef();
            if (ref && tasksValueListenerAttached) {
                try { ref.off('value'); } catch (_) {}
            }
            tasksValueListenerAttached = false;
            cloudTasks = [];
            cloudTasksByKey = {};
        }

        // ========== æ ¸å¿ƒä¸šåŠ¡ï¼šæäº¤/å®¡æ‰¹/å†å² ==========
        function submitTask(taskId, taskName, reward, category) {
            if (!currentUser || currentUser.role !== 'executor') return;

            // é˜²é‡å¤ï¼šåŒä¸€ä»»åŠ¡è‹¥å·²æœ‰ pendingï¼Œå°±ä¸å†æäº¤
            const alreadyPending = cloudTasks.some(t =>
                t && t.status === 'pending' && t.taskId === taskId && t.submitterUsername === currentUser.username
            );
            if (alreadyPending) {
                showMessage('â³ è¿™ä¸ªä»»åŠ¡æ­£åœ¨å®¡æ ¸ä¸­', 'error');
                return;
            }

            const ref = getTasksRef();
            if (!ref) {
                showMessage('âš ï¸ äº‘ç«¯æœªé…ç½®ï¼Œæ— æ³•æäº¤', 'error');
                return;
            }

            const payload = {
                taskId,
                name: taskName,
                reward,
                category,
                status: 'pending',
                // æ–¹æ¡ˆ1ï¼šæŒ‰å­©å­éš”ç¦»ï¼ˆåŒåº“åˆ†å­—æ®µï¼‰
                childId: currentUser.username,
                childName: currentUser.nickname,
                submitterUsername: currentUser.username,
                submitterName: currentUser.nickname,
                createTime: Date.now()
            };

            ref.push().set(payload)
                .then(() => {
                    showMessage('âœ… å·²æäº¤ç»™ç®¡ç†è€…å®¡æ ¸', 'success');
                })
                .catch((e) => {
                    console.error('âŒ æäº¤å¤±è´¥:', e);
                    showMessage('âŒ æäº¤å¤±è´¥ï¼š' + e.message, 'error');
                });
        }

        // 4) ğŸ“… æ‰¹å‡†ï¼šä» /tasks ç§»åˆ° /historyï¼Œå¹¶å†™ finishTime
        function approveTaskCloud(taskKey) {
            if (!currentUser || currentUser.role !== 'admin') return;
            const task = cloudTasksByKey[taskKey];
            if (!task) {
                showMessage('âš ï¸ ä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²è¢«å¤„ç†', 'error');
                return;
            }

            const tasksRef = getTasksRef();
            const historyRef = getHistoryRef();
            if (!tasksRef || !historyRef) {
                showMessage('âš ï¸ äº‘ç«¯æœªé…ç½®ï¼Œæ— æ³•å®¡æ‰¹', 'error');
                return;
            }

            const finishTime = Date.now();
            const historyItem = {
                ...task,
                status: 'approved',
                approverUsername: currentUser.username,
                approverName: currentUser.nickname,
                finishTime
            };
            delete historyItem._key;

            historyRef.push().set(historyItem)
                .then(() => tasksRef.child(taskKey).remove())
                .then(() => {
                    // æœ¬åœ°åˆ†æ•°é€»è¾‘ä¿æŒä¸å˜ï¼šç»™å½“å‰ç™»å½•è€…åŠ åˆ†ï¼ˆç°æœ‰ç³»ç»Ÿè¡Œä¸ºï¼‰
                    currentScore += (parseInt(task.reward, 10) || 0);
                    saveData();
                    refreshUI();
                    showMessage('âœ… æ‰¹å‡†æˆåŠŸ', 'success');
                    fireworks();
                })
                .catch((e) => {
                    console.error('âŒ å®¡æ‰¹å¤±è´¥:', e);
                    showMessage('âŒ å®¡æ‰¹å¤±è´¥ï¼š' + e.message, 'error');
                });
        }

        // æˆé•¿è¶³è¿¹ï¼šæŒ‰æ—¥æœŸå€’åºå±•ç¤º /history
        function openHistory() {
            const ref = getHistoryRef();
            if (!ref) {
                alert('âš ï¸ äº‘ç«¯æœªé…ç½®ï¼Œæ— æ³•æŸ¥çœ‹æˆé•¿è¶³è¿¹');
                return;
            }

            ref.once('value').then(snapshot => {
                const items = [];
                snapshot.forEach(child => {
                    const val = child.val();
                    if (!val) return;
                    items.push({ ...val, _key: child.key });
                });

                items.sort((a, b) => (b.finishTime || 0) - (a.finishTime || 0));

                // æ–¹æ¡ˆ1ï¼šæŒ‰å­©å­è¿‡æ»¤ï¼ˆç®¡ç†å‘˜å¯é€‰æ‹©å…¨éƒ¨/æŸä¸€ä¸ªï¼›å­©å­ç«¯é»˜è®¤åªçœ‹è‡ªå·±ï¼‰
                const f = getEffectiveChildFilter();
                const filtered = (f === 'all') ? items : items.filter(it => normalizeChildId(it) === f);

                if (filtered.length === 0) {
                    alert('ğŸ“œ æˆé•¿è¶³è¿¹\n\næš‚æ— è®°å½•');
                    return;
                }

                const lines = filtered.slice(0, 200).map(it => {
                    const t = formatDateTime(it.finishTime || it.createTime || Date.now());
                    const who = it.childName || it.submitterName || it.childId || it.submitterUsername || 'å­©å­';
                    const reward = (parseInt(it.reward, 10) || 0);
                    return `${t}  ${who} å®Œæˆäº† ${it.name}  +${reward}â­`;
                });

                alert('ğŸ“œ æˆé•¿è¶³è¿¹ï¼ˆå€’åºï¼‰\n\n' + lines.join('\n'));
            }).catch(e => {
                alert('âŒ è¯»å–æˆé•¿è¶³è¿¹å¤±è´¥ï¼š' + e.message);
            });
        }

        // ========== æƒ©ç½š/æ‚¬èµ/å•†åº—ï¼ˆä¿ç•™åŸè¡Œä¸ºï¼‰ ==========
        function applyPenalty(penaltyPoints, penaltyName) {
            if (!currentUser || currentUser.role !== 'admin') return;
            if (confirm(`ç¡®å®šå¯¹ç”¨æˆ·è¿›è¡Œæ‰£åˆ†ã€${penaltyName}ã€‘(${penaltyPoints}â­)å—ï¼Ÿ`)) {
                currentScore += penaltyPoints;
                saveData();
                refreshUI();
                showMessage(`âš ï¸ ${penaltyName}`, 'error');
            }
        }

        function addBounty() {
            const input = document.getElementById('bounty-input');
            const name = (input && input.value || '').trim();
            if (!name) return showMessage('âš ï¸ è¯·è¾“å…¥ä»»åŠ¡åç§°', 'error');

            const newBounty = {
                id: 'b_' + Date.now(),
                name: 'ğŸ“Œ ' + name,
                reward: 10
            };
            tasks.bounty.push(newBounty);
            saveBountyTasks();
            refreshUI();
            input.value = '';
            showMessage('âœ… æ‚¬èµå·²å‘å¸ƒ', 'success');
        }

        function deleteBounty(id) {
            tasks.bounty = tasks.bounty.filter(t => t.id !== id);
            saveBountyTasks();
            refreshUI();
            showMessage('ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤', 'info');
        }

        function buyItem(cost, itemName) {
            if (currentScore < cost) {
                return showMessage('âŒ è£è€€å€¼ä¸è¶³ï¼Œæ— æ³•å…‘æ¢', 'error');
            }
            if (confirm(`ç¡®å®šèŠ±è´¹ ${cost} â­ å…‘æ¢ã€${itemName}ã€‘å—ï¼Ÿ`)) {
                currentScore -= cost;
                saveData();
                refreshUI();
                showMessage(`âœ… å…‘æ¢æˆåŠŸï¼š${itemName}`, 'success');
            }
        }

        // ========== å¯†ç ä¿®æ”¹ï¼ˆä¿ç•™ï¼‰ ==========
        function openPasswordModal() {
            document.getElementById('password-modal').classList.add('show');
        }

        function closePasswordModal(event) {
            if (!event || event.target.id === 'password-modal') {
                document.getElementById('password-modal').classList.remove('show');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            }
        }

        function savePassword() {
            const oldPwd = document.getElementById('old-password').value;
            const newPwd = document.getElementById('new-password').value;
            const confirmPwd = document.getElementById('confirm-password').value;

            if (!currentUser) return;
            if (oldPwd !== currentUser.password) {
                return showMessage('âŒ æ—§å¯†ç é”™è¯¯', 'error');
            }
            if (newPwd.length < 6) {
                return showMessage('âš ï¸ æ–°å¯†ç è‡³å°‘6ä½', 'error');
            }
            if (newPwd !== confirmPwd) {
                return showMessage('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
            }

            allUsers = safeJsonParse(localStorage.getItem(STORAGE.USERS), allUsers) || [];
            const idx = allUsers.findIndex(u => u && u.username === currentUser.username);
            if (idx >= 0) {
                allUsers[idx].password = newPwd;
                localStorage.setItem(STORAGE.USERS, JSON.stringify(allUsers));
            }
            currentUser.password = newPwd;
            persistSession(currentUser);
            closePasswordModal();
            showMessage('âœ… å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
        }

        // ========== ç•Œé¢æ¸²æŸ“ ==========
        function refreshUI() {
            document.getElementById('total-stars').innerText = currentScore;
            updateRank();
            renderPenalties();
            renderPendingList();
            renderTasks();
            renderStore();
        }

        function updateRank() {
            let currentRank = rankSystem[0];
            for (let i = rankSystem.length - 1; i >= 0; i--) {
                if (currentScore >= rankSystem[i].score) {
                    currentRank = rankSystem[i];
                    break;
                }
            }
            document.getElementById('rank-badge').innerText = currentRank.icon + ' ' + currentRank.name;
        }

        function renderPenalties() {
            const container = document.getElementById('penalty-list');
            if (!container) return;
            if (!currentUser || currentUser.role !== 'admin') {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = '';
            penalties.forEach(penalty => {
                container.innerHTML += `
                <div class="task-card penalty">
                    <div class="task-header">
                        <span class="task-name">${penalty.name}</span>
                        <span style="color:#c0392b; font-weight:bold; font-size:15px;">${penalty.penalty} â­</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn-penalty" onclick="applyPenalty(${penalty.penalty}, '${penalty.name}')">æ‰§è¡Œæ‰£åˆ†</button>
                    </div>
                </div>`;
            });
        }

        function renderPendingList() {
            const list = document.getElementById('pending-list');
            if (!list) return;
            if (!currentUser || currentUser.role !== 'admin') return;

            // 3) ğŸ” pending ç½®é¡¶ + âœ… æ‰¹å‡†æŒ‰é’®ï¼ˆé†’ç›®ï¼‰
            const pending = cloudTasks.filter(t => t && t.status === 'pending' && taskPassesChildFilter(t));
            list.innerHTML = '';

            if (pending.length === 0) {
                list.innerHTML = '<div style="color:#999; padding:20px; text-align:center; background:white; border-radius:12px;">æš‚æ— å¾…å®¡æ‰¹ä»»åŠ¡</div>';
                return;
            }

            pending.forEach(task => {
                const timeText = task.createTime ? formatDateTime(task.createTime) : '';
                const who = task.childName || task.submitterName || task.childId || task.submitterUsername || 'å­©å­';
                list.innerHTML += `
                <div class="task-card" style="border-left-color:#27ae60;">
                    <div class="task-header">
                        <div>
                            <div class="task-name">${task.name}</div>
                            <div style="font-size:12px; color:#999; margin-top:5px;">${who} Â· ${timeText}</div>
                        </div>
                        <span class="pending-badge">pending</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn-approve" onclick="approveTaskCloud('${task._key}')">âœ… æ‰¹å‡† (+${parseInt(task.reward, 10) || 0})</button>
                    </div>
                </div>`;
            });
        }

        function renderTasks() {
            renderTaskList('core', tasks.core, 'core-tasks');
            renderTaskList('daily', tasks.daily, 'daily-tasks');
            renderTaskList('bounty', tasks.bounty, 'bounty-tasks');
        }

        function renderTaskList(category, taskList, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            taskList.forEach(task => {
                let actionHtml = '';

                if (currentUser && currentUser.role === 'executor') {
                    const isPending = cloudTasks.some(t =>
                        t && t.status === 'pending' && t.taskId === task.id && t.submitterUsername === currentUser.username
                    );

                    if (isPending) {
                        actionHtml = `<button class="btn-submit" style="background:#ccc; cursor:not-allowed;" disabled>â³ ç­‰å¾…å®¡æ ¸</button>`;
                    } else {
                        actionHtml = `<button class="btn-submit" onclick="submitTask('${task.id}', '${task.name}', ${task.reward}, '${category}')">âœ‹ æˆ‘åšå®Œäº†</button>`;
                    }
                } else {
                    actionHtml = `<div style="font-size:12px; color:#999;">ä»»åŠ¡æ ‡å‡†</div>`;
                    if (category === 'bounty' && currentUser && currentUser.role === 'admin') {
                        actionHtml += ` <button class="btn-delete" onclick="deleteBounty('${task.id}')" style="margin-left:10px;">åˆ é™¤</button>`;
                    }
                }

                container.innerHTML += `
                <div class="task-card ${category}">
                    <div class="task-header">
                        <span class="task-name">${task.name}</span>
                        <span class="task-reward">+${task.reward} â­</span>
                    </div>
                    <div class="task-actions">${actionHtml}</div>
                </div>`;
            });
        }

        function renderStore() {
            const container = document.getElementById('store-items');
            if (!container) return;
            container.innerHTML = '';

            storeItems.forEach(item => {
                const disabled = currentScore < item.cost;
                const btnStyle = disabled ? 'background:#ccc; cursor:not-allowed;' : '';
                container.innerHTML += `
                <div class="store-item">
                    <div>
                        <div class="store-name">${item.name}</div>
                        <div class="store-cost">-${item.cost} â­</div>
                    </div>
                    <button class="btn-buy" style="${btnStyle}" ${disabled ? 'disabled' : ''} onclick="buyItem(${item.cost}, '${item.name}')">å…‘æ¢</button>
                </div>`;
            });
        }

        // ========== å†›è¡”æ¡£æ¡ˆç³»ç»Ÿï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰ ==========
        function openRankModal() {
            let currentRankIndex = 0;
            for (let i = rankSystem.length - 1; i >= 0; i--) {
                if (currentScore >= rankSystem[i].score) {
                    currentRankIndex = i;
                    break;
                }
            }
            const currentRank = rankSystem[currentRankIndex];

            document.getElementById('modal-current-rank').innerText = currentRank.icon + ' ' + currentRank.name;
            document.getElementById('modal-current-score').innerText = `å½“å‰è£è€€ï¼š${currentScore} â­`;

            if (currentRankIndex < rankSystem.length - 1) {
                const nextRank = rankSystem[currentRankIndex + 1];
                const needed = nextRank.score - currentScore;
                const progress = ((currentScore - currentRank.score) / (nextRank.score - currentRank.score) * 100).toFixed(1);

                document.getElementById('modal-progress-info').innerText = `åŠ æ²¹ï¼è¿˜å·® ${needed} åˆ†æ™‹å‡ ${nextRank.name}`;
                document.getElementById('modal-progress-fill').style.width = progress + '%';
            } else {
                document.getElementById('modal-progress-info').innerText = 'ğŸ‰ å·²è¾¾å·…å³°ï¼ä½ æ˜¯æœ€å¼ºçš„äº”æ˜Ÿä¸Šå°†ï¼';
                document.getElementById('modal-progress-fill').style.width = '100%';
            }

            const table = document.getElementById('rank-table');
            table.innerHTML = '';
            rankSystem.forEach((rank, index) => {
                const isCurrent = (index === currentRankIndex);
                const rowClass = isCurrent ? 'current-rank' : '';
                const statusText = isCurrent ? 'ã€å½“å‰ã€‘' : (currentScore >= rank.score ? 'âœ“ å·²è¾¾æˆ' : '');

                table.innerHTML += `
                <tr class="${rowClass}">
                    <td class="rank-icon">${rank.icon}</td>
                    <td class="rank-name">${rank.name} ${statusText}</td>
                    <td class="rank-score">${rank.score} â­</td>
                </tr>`;
            });

            document.getElementById('rank-modal').classList.add('show');
        }

        function closeRankModal(event) {
            if (!event || event.target.id === 'rank-modal') {
                document.getElementById('rank-modal').classList.remove('show');
            }
        }

        // ========== æ•°æ®å¯¼å‡º/å¯¼å…¥ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰ ==========
        function exportData() {
            const allData = {
                users: safeJsonParse(localStorage.getItem(STORAGE.USERS), []),
                bountyTasks: safeJsonParse(localStorage.getItem(STORAGE.BOUNTY), []),
                timestamp: new Date().toISOString(),
                deviceName: navigator.userAgent.substring(0, 50)
            };

            const users = allData.users || [];
            const userDataMap = {};
            users.forEach(user => {
                userDataMap[user.username] = {
                    score: parseInt(localStorage.getItem(`score_${user.username}_v8`), 10) || 0
                };
            });
            allData.userScores = userDataMap;

            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `è£è€€ç³»ç»Ÿæ•°æ®å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showMessage('âœ… æ•°æ®å·²å¯¼å‡ºï¼Œè¯·ä¿å­˜å¥½æ–‡ä»¶', 'success');
        }

        function importData() {
            document.getElementById('import-file').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.users || !importedData.userScores) {
                        return showMessage('âŒ æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ— æ³•å¯¼å…¥', 'error');
                    }

                    if (confirm(`ğŸ“¥ ç¡®å®šè¦å¯¼å…¥è¿™ä»½æ•°æ®å—ï¼Ÿ\næ—¶é—´: ${importedData.timestamp.split('T')[0]}\n\nâš ï¸ æ³¨æ„ï¼šè¿™ä¼šè¦†ç›–ç°æœ‰æ•°æ®ï¼`)) {
                        localStorage.setItem(STORAGE.USERS, JSON.stringify(importedData.users));
                        if (importedData.bountyTasks) {
                            localStorage.setItem(STORAGE.BOUNTY, JSON.stringify(importedData.bountyTasks));
                        }

                        Object.keys(importedData.userScores).forEach(username => {
                            const userData = importedData.userScores[username];
                            localStorage.setItem(`score_${username}_v8`, String(userData.score || 0));
                        });

                        allUsers = importedData.users;
                        showMessage('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼è¯·é‡æ–°ç™»å½•', 'success');
                        setTimeout(() => logout(), 800);
                    }
                } catch (error) {
                    showMessage('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼š' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== æ•°æ®æŒä¹…åŒ– ==========
        function saveData() {
            if (!currentUser) return;
            saveUserLocalScore(currentUser.username, currentScore);
        }

        function saveBountyTasks() {
            localStorage.setItem(STORAGE.BOUNTY, JSON.stringify(tasks.bounty));
        }

        // ========== Firebase è¿æ¥æµ‹è¯•ï¼ˆæ”¹ä¸ºæ ¹èŠ‚ç‚¹ pingï¼‰ ==========
        function testFirebase() {
            try {
                if (typeof firebase === 'undefined' || typeof database === 'undefined') {
                    const msg = 'âš ï¸ Firebase æœªåŠ è½½æˆ–é…ç½®æœªå®Œæˆ';
                    showMessage(msg, 'error');
                    alert(msg);
                    return;
                }
                const ref = database.ref('/ping');
                const payload = { device: navigator.userAgent.substring(0, 60), at: Date.now() };
                ref.set(payload)
                    .then(() => ref.once('value'))
                    .then((snap) => {
                        if (snap && snap.exists()) {
                            const msg = 'âœ… äº‘è¿æ¥æ­£å¸¸ï¼Œå·²å®Œæˆè¯»å†™æµ‹è¯•';
                            showMessage(msg, 'success');
                            alert(msg);
                        } else {
                            const msg = 'âŒ è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è§„åˆ™';
                            showMessage(msg, 'error');
                            alert(msg);
                        }
                    })
                    .catch((e) => {
                        const msg = 'âŒ äº‘è¿æ¥å¼‚å¸¸ï¼š' + e.message;
                        showMessage(msg, 'error');
                        alert(msg);
                    });
            } catch (e) {
                const msg = 'âŒ æµ‹è¯•å¤±è´¥ï¼š' + e.message;
                showMessage(msg, 'error');
                alert(msg);
            }
        }

        console.log('ğŸ¦ è£è€€ç³»ç»Ÿ v12.1.2 å·²åŠ è½½');

        // ========== PWA Service Worker æ³¨å†Œ ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('âœ… Service Worker å·²æ³¨å†Œï¼Œåº”ç”¨å¯ç¦»çº¿ä½¿ç”¨'))
                    .catch((error) => console.log('âš ï¸ Service Worker æ³¨å†Œå¤±è´¥:', error));
            });
        }

        // PWA å®‰è£…æç¤ºå¤„ç†
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('ğŸ’¾ å¯ä»¥å®‰è£…ä¸ºåº”ç”¨');
        });

        // ========== å¯åŠ¨æ—¶ï¼šè‹¥å­˜åœ¨ sessionï¼Œåˆ™è‡ªåŠ¨æ¢å¤ç™»å½•ï¼ˆåˆ·æ–°ä¸ä¸¢ï¼‰ ==========
        window.addEventListener('load', () => {
            const sessUser = loadSession();
            if (sessUser && sessUser.username && sessUser.role) {
                currentUser = sessUser;
                ensureUserInLocalList(sessUser);
                currentScore = loadUserLocalScore(sessUser.username);
                enterApp();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
