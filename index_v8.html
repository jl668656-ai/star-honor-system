<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦ è£è€€ç³»ç»Ÿ v8.0 - ç”¨æˆ·ç®¡ç†ç‰ˆ</title>
    <link rel="apple-touch-icon" href="https://github.githubassets.com/images/icons/emoji/unicode/1f981.png">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1c1c1e;
            -webkit-tap-highlight-color: transparent;
        }

        /* === ç™»å½•/æ³¨å†Œé¡µ === */
        #login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        .auth-box {
            background: white;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }
        .auth-box h1 { text-align: center; margin-bottom: 10px; font-size: 28px; }
        .auth-box p { text-align: center; color: #666; margin-bottom: 25px; font-size: 14px; }
        .auth-input, .auth-select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border 0.3s;
        }
        .auth-input:focus, .auth-select:focus { border-color: #667eea; outline: none; }
        .btn-auth {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .auth-hint { text-align: center; margin-top: 15px; font-size: 12px; color: #999; }
        /* æ ‡ç­¾é¡µ */
        .auth-tab {
            padding: 12px 30px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: #999;
        }
        .auth-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        /* éšè—æ¡† */
        #register-box { display: none; }
        #login-box { display: block; }

        /* === ä¸»åº”ç”¨é¡µ === */
        #app-page {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        .rank-badge { font-size: 18px; color: #667eea; font-weight: bold; margin-bottom: 10px; }
        .stars-display { font-size: 48px; font-weight: 800; color: #333; }
        .user-info { margin-top: 10px; color: #666; font-size: 14px; }
        .user-role { display: inline-block; padding: 4px 12px; background: #f0f0f0; border-radius: 12px; font-size: 12px; margin-left: 10px; }

        /* æ¿å—æ ‡é¢˜ */
        .section-title {
            background: white;
            padding: 15px 20px;
            border-radius: 16px;
            margin: 20px 0 15px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title.core { color: #e74c3c; }
        .section-title.daily { color: #f39c12; }
        .section-title.bounty { color: #9b59b6; }
        .section-title.store { color: #3498db; }
        .section-title.penalty { color: #c0392b; }

        /* ä»»åŠ¡å¡ç‰‡ */
        .task-card {
            background: white;
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 5px solid #ccc;
        }
        .task-card.core { border-left-color: #e74c3c; }
        .task-card.daily { border-left-color: #f39c12; }
        .task-card.bounty { border-left-color: #9b59b6; }
        .task-card.penalty { border-left-color: #c0392b; }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .task-name { font-weight: bold; font-size: 17px; }
        .task-reward { color: #27ae60; font-weight: bold; font-size: 15px; }
        .task-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .pending-badge {
            background: #ffcc00;
            color: #555;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }

        /* æŒ‰é’® */
        button {
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-size: 14px;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-submit { background: #3498db; }
        .btn-approve { background: #27ae60; }
        .btn-crit { background: #e67e22; }
        .btn-reject { background: #e74c3c; }
        .btn-delete { background: #95a5a6; }
        .btn-buy { background: #9b59b6; }
        .btn-penalty { background: #c0392b; }
        .btn-logout { background: #95a5a6; }
        .btn-password { background: #667eea; }
        .btn-view-rank { display: inline-block; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; margin-top: 8px; }

        /* åº•éƒ¨æŒ‰é’®åŒº */
        .bottom-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .bottom-actions button { flex: 1; min-width: 140px; padding: 15px; font-size: 16px; }

        /* è¾“å…¥åŒº */
        .input-area {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .input-area h3 { margin-bottom: 12px; font-size: 16px; color: #666; }
        .input-group { display: flex; gap: 10px; }
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
        }
        .input-group input:focus { border-color: #9b59b6; outline: none; }
        .input-group button { white-space: nowrap; }

        /* å•†åº—å¡ç‰‡ */
        .store-item {
            background: white;
            padding: 15px;
            border-radius: 14px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .store-name { font-weight: bold; font-size: 16px; }
        .store-cost { color: #e74c3c; font-weight: bold; font-size: 14px; margin-top: 5px; }

        /* å¾…å®¡æ‰¹åŒºåŸŸ */
        #dad-zone {
            display: none;
            margin-bottom: 20px;
        }

        /* æç¤ºæ¡† */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            max-width: 80%;
        }

        /* ä¿®æ”¹å¯†ç å¼¹çª—å’Œæ‰¾å›å¯†ç å¼¹çª— */
        #password-modal,
        #reset-password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #password-modal.show,
        #reset-password-modal.show { display: flex; animation: fadeIn 0.3s; }
        .password-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .password-modal-content h2 { margin-bottom: 20px; color: #333; text-align: center; }
        .password-modal-content input {
            width: 100%;
            padding: 12px 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
        }
        .password-modal-content input:focus { border-color: #667eea; outline: none; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; }
        .modal-buttons .btn-approve { background: #27ae60; }
        .modal-buttons .btn-reject { background: #95a5a6; }

        /* å†›è¡”æ¡£æ¡ˆå¼¹çª— */
        #rank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #rank-modal.show { display: flex; animation: fadeIn 0.3s; }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h2 { font-size: 24px; color: #333; margin-bottom: 5px; }
        .modal-header p { color: #999; font-size: 14px; }
        .current-status {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .current-status .rank { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .current-status .score { font-size: 18px; opacity: 0.9; margin-bottom: 15px; }
        .progress-info { font-size: 14px; margin-bottom: 10px; }
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.5s;
        }
        .rank-table {
            width: 100%;
            margin: 20px 0;
        }
        .rank-table tr {
            border-bottom: 1px solid #f0f0f0;
        }
        .rank-table td {
            padding: 12px 8px;
            font-size: 15px;
        }
        .rank-table .rank-icon { font-size: 20px; }
        .rank-table .rank-name { font-weight: bold; color: #333; }
        .rank-table .rank-score { color: #667eea; font-weight: bold; text-align: right; }
        .rank-table tr.current-rank { background: #f0f4ff; }
        .btn-close-modal {
            width: 100%;
            padding: 15px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* æƒé™éšè— */
        .admin-only { display: block; }
        .executor-only { display: block; }
        .hide { display: none !important; }
    </style>
</head>
<body>

    <div id="message-box"></div>

    <!-- ç™»å½•/æ³¨å†Œé¡µ -->
    <div id="login-page">
        
        <!-- æ ‡ç­¾é¡µé€‰æ‹©å™¨ -->
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
            <button id="tab-login" class="auth-tab active" onclick="showLogin()">ğŸš€ ç™»å½•è´¦å·</button>
            <button id="tab-register" class="auth-tab" onclick="showRegister()">ğŸ“ æ³¨å†Œæ–°è´¦å·</button>
        </div>
        
        <!-- ç™»å½•æ¡† -->
        <div class="auth-box" id="login-box">
            <h1>ğŸ¦ è£è€€ç³»ç»Ÿ v8.0</h1>
            <p>ç”¨æˆ·ç®¡ç†ç‰ˆ</p>
            
            <input type="text" id="username" class="auth-input" placeholder="è´¦å·" onkeypress="if(event.key==='Enter') handleLogin()">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç " onkeypress="if(event.key==='Enter') handleLogin()">
            
            <button class="btn-auth" onclick="handleLogin()">ğŸš€ ç™»å½•</button>
            
            <div class="auth-hint">
                é»˜è®¤è´¦å·ï¼šadmin / kid<br>
                é»˜è®¤å¯†ç ï¼š123456
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button style="flex: 1; padding: 12px; background: #f0f0f0; color: #333; border: 2px solid #e0e0e0; border-radius: 10px; font-weight: bold; cursor: pointer;" onclick="showRegister()">ğŸ“ æ³¨å†Œè´¦å·</button>
                <button style="flex: 1; padding: 12px; background: #f0f0f0; color: #333; border: 2px solid #e0e0e0; border-radius: 10px; font-weight: bold; cursor: pointer;" onclick="openResetPasswordModal()">ğŸ”‘ æ‰¾å›å¯†ç </button>
            </div>
        </div>

        <!-- æ³¨å†Œæ¡† -->
        <div class="auth-box" id="register-box">
            <h1>ğŸ¯ åˆ›å»ºæ–°è´¦å·</h1>
            <p>åŠ å…¥è£è€€ç³»ç»Ÿ</p>
            
            <input type="text" id="reg-username" class="auth-input" placeholder="è®¾ç½®è´¦å·ï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰">
            <input type="password" id="reg-password" class="auth-input" placeholder="è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
            <input type="text" id="reg-nickname" class="auth-input" placeholder="æ˜µç§°ï¼ˆæ˜¾ç¤ºåå­—ï¼‰">
            
            <select id="reg-role" class="auth-select">
                <option value="">è¯·é€‰æ‹©èº«ä»½</option>
                <option value="admin">ğŸ›¡ï¸ ç®¡ç†è€…ï¼ˆå¯ä»¥å®¡æ‰¹ä»»åŠ¡ï¼‰</option>
                <option value="executor">âš”ï¸ æ‰§è¡Œè€…ï¼ˆå®Œæˆä»»åŠ¡ï¼‰</option>
            </select>
            
            <button class="btn-auth" onclick="handleRegister()">ğŸ“ æ³¨å†Œè´¦å·</button>
        </div>

    </div>

    <!-- ä¸»åº”ç”¨é¡µ -->
    <div id="app-page">
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="rank-badge" id="rank-badge">ğŸŒ‘ é¢„å¤‡å…µ</div>
            <button class="btn-view-rank" onclick="openRankModal()">ğŸ“‚ æŸ¥çœ‹æ™‹å‡è¡¨</button>
            <div class="stars-display"><span id="total-stars">0</span> â­</div>
            <div class="user-info" id="user-info">æ¬¢è¿å›æ¥ <span class="user-role" id="user-role">ç®¡ç†è€…</span></div>
        </div>

        <!-- çˆ¸çˆ¸å®¡æ‰¹åŒºï¼ˆä»…ç®¡ç†è€…å¯è§ï¼‰ -->
        <div id="dad-zone" class="admin-only">
            <div class="section-title" style="color: #e67e22;">â³ å¾…å®¡æ‰¹ä»»åŠ¡</div>
            <div id="pending-list"></div>
        </div>

        <!-- æƒ©ç½šåŒºï¼ˆä»…ç®¡ç†è€…å¯è§ï¼‰ -->
        <div id="penalty-zone" class="admin-only">
            <div class="section-title penalty">âš ï¸ æƒ©ç½šç®¡ç†</div>
            <div id="penalty-list"></div>
        </div>

        <!-- æ¿å—ä¸€ï¼šæ ¸å¿ƒä½¿å‘½ -->
        <div class="section-title core">ğŸ›¡ï¸ æ ¸å¿ƒä½¿å‘½</div>
        <div id="core-tasks"></div>

        <!-- æ¿å—äºŒï¼šæ¯æ—¥å……èƒ½ -->
        <div class="section-title daily">âš¡ æ¯æ—¥å……èƒ½</div>
        <div id="daily-tasks"></div>

        <!-- æ¿å—ä¸‰ï¼šèµé‡‘æ‚¬èµ -->
        <div class="section-title bounty">ğŸ’° èµé‡‘æ‚¬èµ</div>
        
        <!-- å‘å¸ƒæ‚¬èµè¾“å…¥æ¡†ï¼ˆä»…ç®¡ç†è€…å¯è§ï¼‰ -->
        <div class="input-area admin-only">
            <h3>ğŸ“ å‘å¸ƒæ–°æ‚¬èµ</h3>
            <div class="input-group">
                <input type="text" id="bounty-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                <button class="btn-submit" onclick="addBounty()">å‘å¸ƒ</button>
            </div>
        </div>
        
        <div id="bounty-tasks"></div>

        <!-- å†›éœ€å•†åº— -->
        <div class="section-title store">ğŸª å†›éœ€å•†åº—</div>
        <div id="store-items"></div>

        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="bottom-actions">
            <button class="btn-password" onclick="openPasswordModal()">ğŸ” ä¿®æ”¹å¯†ç </button>
            <button class="btn-logout" onclick="logout()">ğŸšª é€€å‡ºè´¦å·</button>
        </div>

    </div>

    <!-- æ‰¾å›å¯†ç å¼¹çª— -->
    <div id="reset-password-modal" onclick="closeResetPasswordModal(event)">
        <div class="password-modal-content" onclick="event.stopPropagation()">
            <h2>ğŸ”‘ æ‰¾å›å¯†ç </h2>
            
            <input type="text" id="reset-username" class="auth-input" placeholder="è¾“å…¥è´¦å·">
            <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 14px; color: #666;">
                ğŸ’¡ æç¤ºï¼šè¾“å…¥ä½ çš„è´¦å·ï¼Œæ–°å¯†ç å°†é‡ç½®ä¸º <strong>123456</strong>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-approve" onclick="handleResetPassword()">ç¡®è®¤é‡ç½®</button>
                <button class="btn-reject" onclick="closeResetPasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
    <div id="password-modal" onclick="closePasswordModal(event)">
        <div class="password-modal-content" onclick="event.stopPropagation()">
            <h2>ğŸ” ä¿®æ”¹å¯†ç </h2>
            
            <input type="password" id="old-password" class="auth-input" placeholder="è¾“å…¥æ—§å¯†ç ">
            <input type="password" id="new-password" class="auth-input" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
            <input type="password" id="confirm-password" class="auth-input" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
            
            <div class="modal-buttons">
                <button class="btn-approve" onclick="savePassword()">ç¡®è®¤ä¿®æ”¹</button>
                <button class="btn-reject" onclick="closePasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å†›è¡”æ¡£æ¡ˆå¼¹çª— -->
    <div id="rank-modal" onclick="closeRankModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ğŸ† å†›è¡”æ¡£æ¡ˆç³»ç»Ÿ</h2>
                <p>è£è€€æ™‹å‡ä¹‹è·¯</p>
            </div>
            
            <div class="current-status">
                <div class="rank" id="modal-current-rank">ğŸŒ‘ é¢„å¤‡å…µ</div>
                <div class="score" id="modal-current-score">å½“å‰è£è€€ï¼š0 â­</div>
                <div class="progress-info" id="modal-progress-info">åŠ æ²¹ï¼è¿˜å·® 50 åˆ†æ™‹å‡äºŒç­‰å…µ</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="modal-progress-fill" style="width: 0%;"></div>
                </div>
            </div>
            
            <h3 style="margin-bottom: 15px; color: #333;">ğŸ“„ å†›è¡”ä¸€è§ˆè¡¨</h3>
            <table class="rank-table" id="rank-table"></table>
            
            <button class="btn-close-modal" onclick="closeRankModal()">å…³é—­</button>
        </div>
    </div>

    <script>
        // ========== ç”¨æˆ·ç³»ç»Ÿåˆå§‹åŒ– ==========
        let currentUser = null;
        let currentScore = 0;
        let pendingTasks = [];
        
        function initUserSystem() {
            let users = JSON.parse(localStorage.getItem('users_v8')) || [];
            
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œåˆ›å»ºé»˜è®¤è´¦å·
            if (users.length === 0) {
                users = [
                    { username: 'admin', password: '123456', nickname: 'æœ€é«˜æŒ‡æŒ¥å®˜', role: 'admin' },
                    { username: 'kid', password: '123456', nickname: 'ç‰¹ç§å…µ', role: 'executor' }
                ];
                localStorage.setItem('users_v8', JSON.stringify(users));
            }
            return users;
        }

        let allUsers = initUserSystem();

        // ä»»åŠ¡æ•°æ®ç»“æ„
        const tasks = {
            core: [
                { id: 'c1', name: 'ğŸ“ ç‹¬ç«‹å®Œæˆä½œä¸šï¼ˆä¸ç”¨å‚¬ï¼‰', reward: 10 },
                { id: 'c2', name: 'ğŸ¯ æŒ‰æ—¶èµ·åºŠä¸Šå­¦', reward: 5 }
            ],
            daily: [
                { id: 'd1', name: 'ğŸ» ä¸“æ³¨ç»ƒç´ 30åˆ†é’Ÿ', reward: 5 },
                { id: 'd2', name: 'ğŸ“– æ™¨è¯»/èƒŒè¯µ', reward: 3 },
                { id: 'd3', name: 'ğŸƒ æˆ·å¤–è¿åŠ¨ 1å°æ—¶', reward: 5 }
            ],
            bounty: JSON.parse(localStorage.getItem('bountyTasks_v8')) || [
                { id: 'b1', name: 'ğŸ‘¶ å¸¦å¼Ÿå¼Ÿæ²«æ²«ç©è€', reward: 10 },
                { id: 'b2', name: 'ğŸ”§ ååŠ©çˆ¸çˆ¸ä¿®ç†ä¸œè¥¿', reward: 15 }
            ]
        };

        // æƒ©ç½šä»»åŠ¡ï¼ˆä»…ç®¡ç†è€…å¯è§å’Œæ“ä½œï¼‰
        const penalties = [
            { id: 'p1', name: 'ğŸ˜¡ å¯¹é•¿è¾ˆå¤§å¼å¤§å«/é¡¶å˜´', penalty: -20 },
            { id: 'p2', name: 'ğŸ¢ ç£¨ç£¨è¹­è¹­ï¼Œä¸å®ˆæ—¶é—´', penalty: -10 },
            { id: 'p3', name: 'ğŸ“± æœªç»å…è®¸ç©ç”µå­äº§å“', penalty: -50 }
        ];

        // å•†åº—ç‰©å“
        const storeItems = [
            { id: 's1', name: 'ğŸ® ç©æ‰‹æœº 30åˆ†é’Ÿ', cost: 50 },
            { id: 's2', name: 'ğŸ¬ çœ‹ç”µå½±ä¸€éƒ¨', cost: 100 },
            { id: 's3', name: 'ğŸ‘‘ å‘¨æœ«æŒ‡æŒ¥å®˜ï¼ˆå†³å®šå…¨å®¶å»å“ªç©ï¼‰', cost: 300 },
            { id: 's4', name: 'ğŸ› ï¸ å·¥å…·ç®±ä½¿ç”¨æƒï¼ˆå’Œçˆ¸çˆ¸ä¸€èµ·ï¼‰', cost: 100 }
        ];

        // å†›è¡”ç³»ç»Ÿæ•°æ®
        const rankSystem = [
            { score: 0, icon: 'ğŸŒ‘', name: 'é¢„å¤‡å…µ' },
            { score: 50, icon: 'â­ï¸', name: 'äºŒç­‰å…µ' },
            { score: 150, icon: 'â­ï¸â­ï¸', name: 'ä¸‹å£«' },
            { score: 300, icon: 'ğŸŒ™', name: 'ä¸­å£«' },
            { score: 600, icon: 'ğŸŒ™ğŸŒ™', name: 'ä¸Šå°‰' },
            { score: 1000, icon: 'â˜€ï¸', name: 'å°‘æ ¡' },
            { score: 2000, icon: 'ğŸ‘‘', name: 'äº”æ˜Ÿä¸Šå°†' }
        ];

        // ========== ç™»å½•/æ³¨å†Œé€»è¾‘ ==========
        function showLogin() {
            document.getElementById('login-box').style.display = 'block';
            document.getElementById('register-box').style.display = 'none';
            document.getElementById('tab-login').classList.add('active');
            document.getElementById('tab-register').classList.remove('active');
        }

        function showRegister() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('register-box').style.display = 'block';
            document.getElementById('tab-login').classList.remove('active');
            document.getElementById('tab-register').classList.add('active');
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            const user = allUsers.find(u => u.username === username && u.password === password);
            if (!user) {
                showMessage('âŒ è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
                return;
            }

            currentUser = user;
            currentScore = parseInt(localStorage.getItem(`score_${username}_v8`)) || 0;
            pendingTasks = JSON.parse(localStorage.getItem(`pending_${username}_v8`)) || [];
            
            enterApp();
        }

        function handleRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const nickname = document.getElementById('reg-nickname').value.trim();
            const role = document.getElementById('reg-role').value;

            if (!username || username.length < 3 || username.length > 20) {
                return showMessage('âš ï¸ è´¦å·éœ€è¦3-20ä¸ªå­—ç¬¦', 'error');
            }
            if (!password || password.length < 6) {
                return showMessage('âš ï¸ å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
            }
            if (!nickname) {
                return showMessage('âš ï¸ è¯·è¾“å…¥æ˜µç§°', 'error');
            }
            if (!role) {
                return showMessage('âš ï¸ è¯·é€‰æ‹©èº«ä»½', 'error');
            }

            if (allUsers.find(u => u.username === username)) {
                return showMessage('âŒ è´¦å·å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸ªåå­—', 'error');
            }

            const newUser = { username, password, nickname, role };
            allUsers.push(newUser);
            localStorage.setItem('users_v8', JSON.stringify(allUsers));

            showMessage('âœ… æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success');
            setTimeout(showLogin, 1500);

            // æ¸…ç©ºè¡¨å•
            document.getElementById('reg-username').value = '';
            document.getElementById('reg-password').value = '';
            document.getElementById('reg-nickname').value = '';
            document.getElementById('reg-role').value = '';
        }

        function enterApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'block';
            
            const roleText = currentUser.role === 'admin' ? 'ğŸ›¡ï¸ ç®¡ç†è€…' : 'âš”ï¸ æ‰§è¡Œè€…';
            document.getElementById('user-info').innerHTML = `æ¬¢è¿å›æ¥ <span class="user-role">${roleText}</span> (${currentUser.nickname})`;
            
            // æ ¹æ®è§’è‰²æ˜¾ç¤º/éšè—å†…å®¹
            const adminElements = document.querySelectorAll('.admin-only');
            const executorElements = document.querySelectorAll('.executor-only');
            
            if (currentUser.role === 'admin') {
                adminElements.forEach(el => el.classList.remove('hide'));
                executorElements.forEach(el => el.classList.add('hide'));
            } else {
                adminElements.forEach(el => el.classList.add('hide'));
                executorElements.forEach(el => el.classList.remove('hide'));
            }

            refreshUI();
        }

        function logout() {
            saveData();
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            currentUser = null;
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showLogin();
        }

        // ========== æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ==========
        function submitTask(taskId, taskName, reward, category) {
            if (currentUser.role === 'executor') {
                const isPending = pendingTasks.find(t => t.uid === taskId + '_pending');
                if (isPending) return showMessage('â³ è¿™ä¸ªä»»åŠ¡æ­£åœ¨å®¡æ ¸ä¸­', 'error');

                const request = {
                    uid: taskId + '_pending',
                    name: taskName,
                    reward: reward,
                    category: category,
                    time: new Date().toLocaleTimeString()
                };
                
                pendingTasks.push(request);
                saveData();
                refreshUI();
                showMessage('âœ… å·²æäº¤ç»™ç®¡ç†è€…å®¡æ ¸', 'success');
            }
        }

        function applyPenalty(penaltyPoints, penaltyName) {
            if (currentUser.role === 'admin') {
                if (confirm(`ç¡®å®šå¯¹ç”¨æˆ·è¿›è¡Œæ‰£åˆ†ã€${penaltyName}ã€‘(${penaltyPoints}â­)å—ï¼Ÿ`)) {
                    currentScore += penaltyPoints;
                    saveData();
                    refreshUI();
                    showMessage(`âš ï¸ ${penaltyName}`, 'error');
                }
            }
        }

        function approveTask(index, isCrit) {
            const task = pendingTasks[index];
            const finalPoints = isCrit ? Math.floor(task.reward * 1.5 + 2) : task.reward;

            currentScore += finalPoints;
            pendingTasks.splice(index, 1);
            
            saveData();
            refreshUI();
            
            if (isCrit) {
                showMessage(`ğŸ”¥ å®¡æ‰¹é€šè¿‡ï¼æ€åº¦æå¥½ +${finalPoints}`, 'success');
                fireworks();
            } else {
                showMessage(`âœ… å®¡æ‰¹é€šè¿‡ +${finalPoints}`, 'success');
            }
        }

        function rejectTask(index) {
            if (confirm('ç¡®å®šé©³å›è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                pendingTasks.splice(index, 1);
                saveData();
                refreshUI();
                showMessage('âŒ ä»»åŠ¡è¢«é©³å›', 'error');
            }
        }

        function addBounty() {
            const input = document.getElementById('bounty-input');
            const name = input.value.trim();
            if (!name) return showMessage('âš ï¸ è¯·è¾“å…¥ä»»åŠ¡åç§°', 'error');

            const newBounty = {
                id: 'b_' + Date.now(),
                name: 'ğŸ“Œ ' + name,
                reward: 10
            };

            tasks.bounty.push(newBounty);
            saveBountyTasks();
            refreshUI();
            input.value = '';
            showMessage('âœ… æ‚¬èµå·²å‘å¸ƒ', 'success');
        }

        function deleteBounty(id) {
            tasks.bounty = tasks.bounty.filter(t => t.id !== id);
            saveBountyTasks();
            refreshUI();
            showMessage('ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤', 'info');
        }

        function buyItem(cost, itemName) {
            if (currentScore < cost) {
                return showMessage('âŒ è£è€€å€¼ä¸è¶³ï¼Œæ— æ³•å…‘æ¢', 'error');
            }
            
            if (confirm(`ç¡®å®šèŠ±è´¹ ${cost} â­ å…‘æ¢ã€${itemName}ã€‘å—ï¼Ÿ`)) {
                currentScore -= cost;
                saveData();
                refreshUI();
                showMessage(`âœ… å…‘æ¢æˆåŠŸï¼š${itemName}`, 'success');
            }
        }

        // ========== å¯†ç ä¿®æ”¹ ==========
        function openPasswordModal() {
            document.getElementById('password-modal').classList.add('show');
        }

        function closePasswordModal(event) {
            if (!event || event.target.id === 'password-modal') {
                document.getElementById('password-modal').classList.remove('show');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            }
        }

        function openResetPasswordModal() {
            document.getElementById('reset-password-modal').classList.add('show');
            document.getElementById('reset-username').value = '';
        }

        function closeResetPasswordModal(event) {
            if (!event || event.target.id === 'reset-password-modal') {
                document.getElementById('reset-password-modal').classList.remove('show');
                document.getElementById('reset-username').value = '';
            }
        }

        function handleResetPassword() {
            const username = document.getElementById('reset-username').value.trim();
            
            if (!username) {
                return showMessage('âš ï¸ è¯·è¾“å…¥è´¦å·', 'error');
            }

            const userIndex = allUsers.findIndex(u => u.username === username);
            if (userIndex === -1) {
                return showMessage('âŒ è´¦å·ä¸å­˜åœ¨', 'error');
            }

            allUsers[userIndex].password = '123456';
            localStorage.setItem('users_v8', JSON.stringify(allUsers));

            closeResetPasswordModal();
            showMessage('âœ… å¯†ç å·²é‡ç½®ä¸º 123456ï¼Œè¯·ç™»å½•', 'success');
            setTimeout(() => showLogin(), 1500);
        }

        function savePassword() {
            const oldPwd = document.getElementById('old-password').value;
            const newPwd = document.getElementById('new-password').value;
            const confirmPwd = document.getElementById('confirm-password').value;

            if (oldPwd !== currentUser.password) {
                return showMessage('âŒ æ—§å¯†ç é”™è¯¯', 'error');
            }
            if (newPwd.length < 6) {
                return showMessage('âš ï¸ æ–°å¯†ç è‡³å°‘6ä½', 'error');
            }
            if (newPwd !== confirmPwd) {
                return showMessage('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
            }

            // æ›´æ–°ç”¨æˆ·å¯†ç 
            const userIndex = allUsers.findIndex(u => u.username === currentUser.username);
            allUsers[userIndex].password = newPwd;
            currentUser.password = newPwd;
            localStorage.setItem('users_v8', JSON.stringify(allUsers));

            closePasswordModal();
            showMessage('âœ… å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
        }

        // ========== ç•Œé¢æ¸²æŸ“ ==========
        function refreshUI() {
            document.getElementById('total-stars').innerText = currentScore;
            updateRank();
            renderPenalties();
            renderPendingList();
            renderTasks();
            renderStore();
        }

        function updateRank() {
            let currentRank = rankSystem[0];
            for (let i = rankSystem.length - 1; i >= 0; i--) {
                if (currentScore >= rankSystem[i].score) {
                    currentRank = rankSystem[i];
                    break;
                }
            }
            document.getElementById('rank-badge').innerText = currentRank.icon + ' ' + currentRank.name;
        }

        function renderPenalties() {
            const container = document.getElementById('penalty-list');
            if (!container) return;
            container.innerHTML = '';
            
            penalties.forEach(penalty => {
                container.innerHTML += `
                <div class="task-card penalty">
                    <div class="task-header">
                        <span class="task-name">${penalty.name}</span>
                        <span style="color:#c0392b; font-weight:bold; font-size:15px;">${penalty.penalty} â­</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn-penalty" onclick="applyPenalty(${penalty.penalty}, '${penalty.name}')">æ‰§è¡Œæ‰£åˆ†</button>
                    </div>
                </div>`;
            });
        }

        function renderPendingList() {
            const dadZone = document.getElementById('dad-zone');
            const list = document.getElementById('pending-list');
            
            if (currentUser.role !== 'admin') return;
            
            list.innerHTML = '';
            
            if (pendingTasks.length === 0) {
                list.innerHTML = '<div style="color:#999; padding:20px; text-align:center; background:white; border-radius:12px;">æš‚æ— å¾…å®¡æ‰¹ä»»åŠ¡</div>';
            } else {
                pendingTasks.forEach((task, index) => {
                    list.innerHTML += `
                    <div class="task-card" style="border-left-color: #e67e22;">
                        <div class="task-header">
                            <div>
                                <div class="task-name">${task.name}</div>
                                <div style="font-size:12px; color:#999; margin-top:5px;">æäº¤æ—¶é—´: ${task.time}</div>
                            </div>
                            <span class="pending-badge">å¾…å®¡æ ¸</span>
                        </div>
                        <div class="task-actions">
                            <button class="btn-reject" onclick="rejectTask(${index})">é©³å›</button>
                            <button class="btn-approve" onclick="approveTask(${index}, false)">é€šè¿‡ (+${task.reward})</button>
                            <button class="btn-crit" onclick="approveTask(${index}, true)">ğŸ”¥ æ€åº¦è¶…å¥½ (+${Math.floor(task.reward * 1.5 + 2)})</button>
                        </div>
                    </div>`;
                });
            }
        }

        function renderTasks() {
            renderTaskList('core', tasks.core, 'core-tasks');
            renderTaskList('daily', tasks.daily, 'daily-tasks');
            renderTaskList('bounty', tasks.bounty, 'bounty-tasks');
        }

        function renderTaskList(category, taskList, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            taskList.forEach(task => {
                const isPending = pendingTasks.find(t => t.uid === task.id + '_pending');
                
                let actionHtml = '';
                if (currentUser.role === 'executor') {
                    if (isPending) {
                        actionHtml = `<button class="btn-submit" style="background:#ccc; cursor:not-allowed;" disabled>â³ ç­‰å¾…å®¡æ ¸</button>`;
                    } else {
                        actionHtml = `<button class="btn-submit" onclick="submitTask('${task.id}', '${task.name}', ${task.reward}, '${category}')">âœ‹ æˆ‘åšå®Œäº†</button>`;
                    }
                    
                    if (category === 'bounty') {
                        actionHtml += '';
                    }
                } else {
                    actionHtml = `<div style="font-size:12px; color:#999;">ä»»åŠ¡æ ‡å‡†</div>`;
                    
                    if (category === 'bounty') {
                        actionHtml += ` <button class="btn-delete" onclick="deleteBounty('${task.id}')" style="margin-left:10px;">åˆ é™¤</button>`;
                    }
                }

                container.innerHTML += `
                <div class="task-card ${category}">
                    <div class="task-header">
                        <span class="task-name">${task.name}</span>
                        <span class="task-reward">+${task.reward} â­</span>
                    </div>
                    <div class="task-actions">${actionHtml}</div>
                </div>`;
            });
        }

        function renderStore() {
            const container = document.getElementById('store-items');
            container.innerHTML = '';
            
            storeItems.forEach(item => {
                const disabled = currentScore < item.cost;
                const btnStyle = disabled ? 'background:#ccc; cursor:not-allowed;' : '';
                
                container.innerHTML += `
                <div class="store-item">
                    <div>
                        <div class="store-name">${item.name}</div>
                        <div class="store-cost">-${item.cost} â­</div>
                    </div>
                    <button class="btn-buy" style="${btnStyle}" ${disabled ? 'disabled' : ''} onclick="buyItem(${item.cost}, '${item.name}')">å…‘æ¢</button>
                </div>`;
            });
        }

        // ========== å†›è¡”æ¡£æ¡ˆç³»ç»Ÿ ==========
        function openRankModal() {
            let currentRankIndex = 0;
            for (let i = rankSystem.length - 1; i >= 0; i--) {
                if (currentScore >= rankSystem[i].score) {
                    currentRankIndex = i;
                    break;
                }
            }
            const currentRank = rankSystem[currentRankIndex];
            
            document.getElementById('modal-current-rank').innerText = currentRank.icon + ' ' + currentRank.name;
            document.getElementById('modal-current-score').innerText = `å½“å‰è£è€€ï¼š${currentScore} â­`;
            
            if (currentRankIndex < rankSystem.length - 1) {
                const nextRank = rankSystem[currentRankIndex + 1];
                const needed = nextRank.score - currentScore;
                const progress = ((currentScore - currentRank.score) / (nextRank.score - currentRank.score) * 100).toFixed(1);
                
                document.getElementById('modal-progress-info').innerText = `åŠ æ²¹ï¼è¿˜å·® ${needed} åˆ†æ™‹å‡ ${nextRank.name}`;
                document.getElementById('modal-progress-fill').style.width = progress + '%';
            } else {
                document.getElementById('modal-progress-info').innerText = 'ğŸ‰ å·²è¾¾å·…å³°ï¼ä½ æ˜¯æœ€å¼ºçš„äº”æ˜Ÿä¸Šå°†ï¼';
                document.getElementById('modal-progress-fill').style.width = '100%';
            }
            
            const table = document.getElementById('rank-table');
            table.innerHTML = '';
            rankSystem.forEach((rank, index) => {
                const isCurrent = (index === currentRankIndex);
                const rowClass = isCurrent ? 'current-rank' : '';
                const statusText = isCurrent ? 'ã€å½“å‰ã€‘' : (currentScore >= rank.score ? 'âœ“ å·²è¾¾æˆ' : '');
                
                table.innerHTML += `
                <tr class="${rowClass}">
                    <td class="rank-icon">${rank.icon}</td>
                    <td class="rank-name">${rank.name} ${statusText}</td>
                    <td class="rank-score">${rank.score} â­</td>
                </tr>`;
            });
            
            document.getElementById('rank-modal').classList.add('show');
        }

        function closeRankModal(event) {
            if (!event || event.target.id === 'rank-modal') {
                document.getElementById('rank-modal').classList.remove('show');
            }
        }

        // ========== æ•°æ®æŒä¹…åŒ– ==========
        function saveData() {
            localStorage.setItem(`score_${currentUser.username}_v8`, currentScore);
            localStorage.setItem(`pending_${currentUser.username}_v8`, JSON.stringify(pendingTasks));
        }

        function saveBountyTasks() {
            localStorage.setItem('bountyTasks_v8', JSON.stringify(tasks.bounty));
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function showMessage(text, type) {
            const box = document.getElementById('message-box');
            if (!box) return;
            box.innerText = text;
            box.style.opacity = 1;
            box.style.backgroundColor = type === 'success' ? '#27ae60' : (type === 'error' ? '#e74c3c' : '#3498db');
            setTimeout(() => { box.style.opacity = 0; }, 2500);
        }

        function fireworks() {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        console.log('ğŸ¦ è£è€€ç³»ç»Ÿ v8.0 ç”¨æˆ·ç®¡ç†ç‰ˆå·²åŠ è½½');
    </script>
</body>
</html>
