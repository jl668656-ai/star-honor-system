<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦ è£è€€ç³»ç»Ÿ v7.0</title>
    <link rel="apple-touch-icon" href="https://github.githubassets.com/images/icons/emoji/unicode/1f981.png">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1c1c1e;
            -webkit-tap-highlight-color: transparent;
        }

        /* === ç™»å½•é¡µ === */
        #login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        .login-box {
            background: white;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }
        .login-box h1 { text-align: center; margin-bottom: 10px; font-size: 28px; }
        .login-box p { text-align: center; color: #666; margin-bottom: 25px; font-size: 14px; }
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border 0.3s;
        }
        .login-input:focus { border-color: #667eea; outline: none; }
        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .login-hint { text-align: center; margin-top: 15px; font-size: 12px; color: #999; }

        /* === ä¸»åº”ç”¨é¡µ === */
        #app-page {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }
        .rank-badge { font-size: 18px; color: #667eea; font-weight: bold; margin-bottom: 10px; }
        .stars-display { font-size: 48px; font-weight: 800; color: #333; }
        .user-info { margin-top: 10px; color: #666; font-size: 14px; }

        /* æ¿å—æ ‡é¢˜ */
        .section-title {
            background: white;
            padding: 15px 20px;
            border-radius: 16px;
            margin: 20px 0 15px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title.core { color: #e74c3c; }
        .section-title.daily { color: #f39c12; }
        .section-title.bounty { color: #9b59b6; }
        .section-title.store { color: #3498db; }

        /* ä»»åŠ¡å¡ç‰‡ */
        .task-card {
            background: white;
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 5px solid #ccc;
        }
        .task-card.core { border-left-color: #e74c3c; }
        .task-card.daily { border-left-color: #f39c12; }
        .task-card.bounty { border-left-color: #9b59b6; }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .task-name { font-weight: bold; font-size: 17px; }
        .task-reward { color: #27ae60; font-weight: bold; font-size: 15px; }
        .task-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .pending-badge {
            background: #ffcc00;
            color: #555;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }

        /* æŒ‰é’® */
        button {
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-size: 14px;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-submit { background: #3498db; }
        .btn-approve { background: #27ae60; }
        .btn-crit { background: #e67e22; }
        .btn-reject { background: #e74c3c; }
        .btn-delete { background: #95a5a6; }
        .btn-buy { background: #9b59b6; }
        .btn-logout { background: #95a5a6; width: 100%; padding: 15px; margin-top: 30px; font-size: 16px; }

        /* è¾“å…¥åŒº */
        .input-area {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .input-area h3 { margin-bottom: 12px; font-size: 16px; color: #666; }
        .input-group { display: flex; gap: 10px; }
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
        }
        .input-group input:focus { border-color: #9b59b6; outline: none; }
        .input-group button { white-space: nowrap; }

        /* å•†åº—å¡ç‰‡ */
        .store-item {
            background: white;
            padding: 15px;
            border-radius: 14px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .store-name { font-weight: bold; font-size: 16px; }
        .store-cost { color: #e74c3c; font-weight: bold; font-size: 14px; margin-top: 5px; }

        /* å¾…å®¡æ‰¹åŒºåŸŸ */
        #dad-zone {
            display: none;
            margin-bottom: 20px;
        }

        /* æç¤ºæ¡† */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            max-width: 80%;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="message-box"></div>

    <!-- ç™»å½•é¡µ -->
    <div id="login-page">
        <div class="login-box">
            <h1>ğŸ¦ è£è€€ç³»ç»Ÿ v7.0</h1>
            <p>è¯·é€‰æ‹©èº«ä»½ç™»å½•</p>
            
            <input type="text" id="username" class="login-input" placeholder="è´¦å· (kid / dad)" onkeypress="if(event.key==='Enter') handleLogin()">
            <input type="password" id="password" class="login-input" placeholder="å¯†ç " onkeypress="if(event.key==='Enter') handleLogin()">
            
            <button class="btn-login" onclick="handleLogin()">ğŸš€ è¿›å…¥ç³»ç»Ÿ</button>
            
            <div class="login-hint">
                é»˜è®¤å¯†ç ï¼š123456<br>
                å­©å­è´¦å·: kid | çˆ¸çˆ¸è´¦å·: dad
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨é¡µ -->
    <div id="app-page">
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="rank-badge" id="rank-badge">ğŸŒ‘ é¢„å¤‡å…µ</div>
            <div class="stars-display"><span id="total-stars">0</span> â­</div>
            <div class="user-info" id="user-info">æ¬¢è¿å›æ¥</div>
        </div>

        <!-- çˆ¸çˆ¸å®¡æ‰¹åŒº -->
        <div id="dad-zone">
            <div class="section-title" style="color: #e67e22;">â³ å¾…å®¡æ‰¹ä»»åŠ¡</div>
            <div id="pending-list"></div>
        </div>

        <!-- æ¿å—ä¸€ï¼šæ ¸å¿ƒä½¿å‘½ -->
        <div class="section-title core">ğŸ›¡ï¸ æ ¸å¿ƒä½¿å‘½</div>
        <div id="core-tasks"></div>

        <!-- æ¿å—äºŒï¼šæ¯æ—¥å……èƒ½ -->
        <div class="section-title daily">âš¡ æ¯æ—¥å……èƒ½</div>
        <div id="daily-tasks"></div>

        <!-- æ¿å—ä¸‰ï¼šèµé‡‘æ‚¬èµ -->
        <div class="section-title bounty">ğŸ’° èµé‡‘æ‚¬èµ</div>
        
        <!-- å‘å¸ƒæ‚¬èµè¾“å…¥æ¡† -->
        <div class="input-area">
            <h3>ğŸ“ å‘å¸ƒæ–°æ‚¬èµ</h3>
            <div class="input-group">
                <input type="text" id="bounty-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°ï¼Œä¾‹å¦‚ï¼šå€’åƒåœ¾">
                <button class="btn-submit" onclick="addBounty()">å‘å¸ƒæ‚¬èµ</button>
            </div>
        </div>
        
        <div id="bounty-tasks"></div>

        <!-- å†›éœ€å•†åº— -->
        <div class="section-title store">ğŸª å†›éœ€å•†åº—</div>
        <div id="store-items"></div>

        <!-- é€€å‡ºæŒ‰é’® -->
        <button class="btn-logout" onclick="logout()">ğŸšª é€€å‡ºè´¦å·</button>

    </div>

    <script>
        // ========== æ•°æ®åˆå§‹åŒ– ==========
        let currentScore = parseInt(localStorage.getItem('honorScore_v7')) || 0;
        let pendingTasks = JSON.parse(localStorage.getItem('pendingTasks_v7')) || [];
        let currentUser = null;

        // ä»»åŠ¡æ•°æ®ç»“æ„
        const tasks = {
            core: [
                { id: 'c1', name: 'ğŸ“ ç‹¬ç«‹å®Œæˆä½œä¸šï¼ˆä¸ç”¨å‚¬ï¼‰', reward: 10 },
                { id: 'c2', name: 'ğŸ¯ æŒ‰æ—¶èµ·åºŠä¸Šå­¦', reward: 5 }
            ],
            daily: [
                { id: 'd1', name: 'ğŸ» ä¸“æ³¨ç»ƒç´ 30åˆ†é’Ÿ', reward: 5 },
                { id: 'd2', name: 'ğŸ“– æ™¨è¯»/èƒŒè¯µ', reward: 3 },
                { id: 'd3', name: 'ğŸƒ æˆ·å¤–è¿åŠ¨ 1å°æ—¶', reward: 5 }
            ],
            bounty: JSON.parse(localStorage.getItem('bountyTasks_v7')) || [
                { id: 'b1', name: 'ğŸ‘¶ å¸¦å¼Ÿå¼Ÿæ²«æ²«ç©è€', reward: 10 },
                { id: 'b2', name: 'ğŸ”§ ååŠ©çˆ¸çˆ¸ä¿®ç†ä¸œè¥¿', reward: 15 }
            ]
        };

        // å•†åº—ç‰©å“
        const storeItems = [
            { id: 's1', name: 'ğŸ® ç©æ‰‹æœº 30åˆ†é’Ÿ', cost: 50 },
            { id: 's2', name: 'ğŸ¬ çœ‹ç”µå½±ä¸€éƒ¨', cost: 100 },
            { id: 's3', name: 'ğŸ‘‘ å‘¨æœ«æŒ‡æŒ¥å®˜ï¼ˆå†³å®šå…¨å®¶å»å“ªç©ï¼‰', cost: 300 },
            { id: 's4', name: 'ğŸ› ï¸ å·¥å…·ç®±ä½¿ç”¨æƒï¼ˆå’Œçˆ¸çˆ¸ä¸€èµ·ï¼‰', cost: 100 }
        ];

        // ========== ç™»å½•é€»è¾‘ ==========
        function handleLogin() {
            const user = document.getElementById('username').value.toLowerCase().trim();
            const pass = document.getElementById('password').value.trim();

            if ((user === 'kid' || user === 'dad') && pass === '123456') {
                currentUser = user;
                enterApp();
            } else {
                showMessage('âŒ è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
            }
        }

        function logout() {
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            currentUser = null;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function enterApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'block';
            document.getElementById('user-info').innerText = (currentUser === 'dad') ? 'ğŸ‘¨â€âœˆï¸ ç®¡ç†å‘˜æ¨¡å¼ (çˆ¸çˆ¸)' : 'ğŸ§‘â€ğŸš€ æŒ‘æˆ˜è€…æ¨¡å¼ (å„¿å­)';
            
            refreshUI();
        }

        // ========== æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ==========

        // æäº¤ä»»åŠ¡
        function submitTask(taskId, taskName, reward, category) {
            const isPending = pendingTasks.find(t => t.uid === taskId + '_pending');
            if (isPending) return showMessage('â³ è¿™ä¸ªä»»åŠ¡æ­£åœ¨å®¡æ ¸ä¸­', 'error');

            const request = {
                uid: taskId + '_pending',
                name: taskName,
                reward: reward,
                category: category,
                time: new Date().toLocaleTimeString()
            };
            
            pendingTasks.push(request);
            saveData();
            refreshUI();
            showMessage('âœ… å·²æäº¤ç»™çˆ¸çˆ¸å®¡æ ¸', 'success');
        }

        // çˆ¸çˆ¸å®¡æ ¸ - é€šè¿‡
        function approveTask(index, isCrit) {
            const task = pendingTasks[index];
            const finalPoints = isCrit ? Math.floor(task.reward * 1.5 + 2) : task.reward;

            currentScore += finalPoints;
            pendingTasks.splice(index, 1);
            
            saveData();
            refreshUI();
            
            if (isCrit) {
                showMessage(`ğŸ”¥ å®¡æ‰¹é€šè¿‡ï¼æ€åº¦æå¥½ +${finalPoints}`, 'success');
                fireworks();
            } else {
                showMessage(`âœ… å®¡æ‰¹é€šè¿‡ +${finalPoints}`, 'success');
            }
        }

        // çˆ¸çˆ¸å®¡æ ¸ - é©³å›
        function rejectTask(index) {
            if (confirm('ç¡®å®šé©³å›è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                pendingTasks.splice(index, 1);
                saveData();
                refreshUI();
                showMessage('âŒ ä»»åŠ¡è¢«é©³å›', 'error');
            }
        }

        // æ·»åŠ èµé‡‘ä»»åŠ¡
        function addBounty() {
            const input = document.getElementById('bounty-input');
            const name = input.value.trim();
            if (!name) return showMessage('âš ï¸ è¯·è¾“å…¥ä»»åŠ¡åç§°', 'error');

            const newBounty = {
                id: 'b_' + Date.now(),
                name: 'ğŸ“Œ ' + name,
                reward: 10
            };

            tasks.bounty.push(newBounty);
            saveBountyTasks();
            refreshUI();
            input.value = '';
            showMessage('âœ… æ‚¬èµå·²å‘å¸ƒ', 'success');
        }

        // åˆ é™¤èµé‡‘ä»»åŠ¡
        function deleteBounty(id) {
            tasks.bounty = tasks.bounty.filter(t => t.id !== id);
            saveBountyTasks();
            refreshUI();
            showMessage('ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤', 'info');
        }

        // å•†åº—å…‘æ¢
        function buyItem(cost, itemName) {
            if (currentScore < cost) {
                return showMessage('âŒ è£è€€å€¼ä¸è¶³ï¼Œæ— æ³•å…‘æ¢', 'error');
            }
            
            if (confirm(`ç¡®å®šèŠ±è´¹ ${cost} â­ å…‘æ¢ã€${itemName}ã€‘å—ï¼Ÿ`)) {
                currentScore -= cost;
                saveData();
                refreshUI();
                showMessage(`âœ… å…‘æ¢æˆåŠŸï¼š${itemName}`, 'success');
            }
        }

        // ========== ç•Œé¢æ¸²æŸ“ ==========
        function refreshUI() {
            document.getElementById('total-stars').innerText = currentScore;
            updateRank();
            renderPendingList();
            renderTasks();
            renderStore();
        }

        function updateRank() {
            let rank = 'ğŸŒ‘ é¢„å¤‡å…µ';
            if (currentScore >= 2000) rank = 'ğŸ‘‘ äº”æ˜Ÿä¸Šå°†';
            else if (currentScore >= 1000) rank = 'â˜€ï¸ å°‘æ ¡';
            else if (currentScore >= 600) rank = 'ğŸŒ™ğŸŒ™ ä¸Šå°‰';
            else if (currentScore >= 300) rank = 'ğŸŒ™ ä¸­å£«';
            else if (currentScore >= 150) rank = 'â­â­ ä¸‹å£«';
            else if (currentScore >= 50) rank = 'â­ äºŒç­‰å…µ';
            document.getElementById('rank-badge').innerText = rank;
        }

        function renderPendingList() {
            const dadZone = document.getElementById('dad-zone');
            const list = document.getElementById('pending-list');
            
            if (currentUser === 'dad') {
                dadZone.style.display = 'block';
                list.innerHTML = '';
                
                if (pendingTasks.length === 0) {
                    list.innerHTML = '<div style="color:#999; padding:20px; text-align:center; background:white; border-radius:12px;">æš‚æ— å¾…å®¡æ‰¹ä»»åŠ¡</div>';
                } else {
                    pendingTasks.forEach((task, index) => {
                        list.innerHTML += `
                        <div class="task-card" style="border-left-color: #e67e22;">
                            <div class="task-header">
                                <div>
                                    <div class="task-name">${task.name}</div>
                                    <div style="font-size:12px; color:#999; margin-top:5px;">æäº¤æ—¶é—´: ${task.time}</div>
                                </div>
                                <span class="pending-badge">å¾…å®¡æ ¸</span>
                            </div>
                            <div class="task-actions">
                                <button class="btn-reject" onclick="rejectTask(${index})">é©³å›</button>
                                <button class="btn-approve" onclick="approveTask(${index}, false)">é€šè¿‡ (+${task.reward})</button>
                                <button class="btn-crit" onclick="approveTask(${index}, true)">ğŸ”¥ æ€åº¦è¶…å¥½ (+${Math.floor(task.reward * 1.5 + 2)})</button>
                            </div>
                        </div>`;
                    });
                }
            } else {
                dadZone.style.display = 'none';
            }
        }

        function renderTasks() {
            // æ¸²æŸ“æ ¸å¿ƒä½¿å‘½
            renderTaskList('core', tasks.core, 'core-tasks');
            // æ¸²æŸ“æ¯æ—¥å……èƒ½
            renderTaskList('daily', tasks.daily, 'daily-tasks');
            // æ¸²æŸ“èµé‡‘æ‚¬èµ
            renderTaskList('bounty', tasks.bounty, 'bounty-tasks');
        }

        function renderTaskList(category, taskList, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            taskList.forEach(task => {
                const isPending = pendingTasks.find(t => t.uid === task.id + '_pending');
                
                let actionHtml = '';
                if (currentUser === 'kid') {
                    if (isPending) {
                        actionHtml = `<button class="btn-submit" style="background:#ccc; cursor:not-allowed;" disabled>â³ ç­‰å¾…å®¡æ ¸</button>`;
                    } else {
                        actionHtml = `<button class="btn-submit" onclick="submitTask('${task.id}', '${task.name}', ${task.reward}, '${category}')">âœ‹ æˆ‘åšå®Œäº†</button>`;
                    }
                    
                    // èµé‡‘ä»»åŠ¡é¢å¤–åŠ åˆ é™¤æŒ‰é’®
                    if (category === 'bounty') {
                        actionHtml += ` <button class="btn-delete" onclick="deleteBounty('${task.id}')">åˆ é™¤</button>`;
                    }
                } else {
                    actionHtml = `<div style="font-size:12px; color:#999;">ä»»åŠ¡æ ‡å‡†</div>`;
                }

                container.innerHTML += `
                <div class="task-card ${category}">
                    <div class="task-header">
                        <span class="task-name">${task.name}</span>
                        <span class="task-reward">+${task.reward} â­</span>
                    </div>
                    <div class="task-actions">${actionHtml}</div>
                </div>`;
            });
        }

        function renderStore() {
            const container = document.getElementById('store-items');
            container.innerHTML = '';
            
            storeItems.forEach(item => {
                const disabled = currentScore < item.cost;
                const btnStyle = disabled ? 'background:#ccc; cursor:not-allowed;' : '';
                
                container.innerHTML += `
                <div class="store-item">
                    <div>
                        <div class="store-name">${item.name}</div>
                        <div class="store-cost">-${item.cost} â­</div>
                    </div>
                    <button class="btn-buy" style="${btnStyle}" ${disabled ? 'disabled' : ''} onclick="buyItem(${item.cost}, '${item.name}')">å…‘æ¢</button>
                </div>`;
            });
        }

        // ========== æ•°æ®æŒä¹…åŒ– ==========
        function saveData() {
            localStorage.setItem('honorScore_v7', currentScore);
            localStorage.setItem('pendingTasks_v7', JSON.stringify(pendingTasks));
        }

        function saveBountyTasks() {
            localStorage.setItem('bountyTasks_v7', JSON.stringify(tasks.bounty));
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function showMessage(text, type) {
            const box = document.getElementById('message-box');
            if (!box) return;
            box.innerText = text;
            box.style.opacity = 1;
            box.style.backgroundColor = type === 'success' ? '#27ae60' : (type === 'error' ? '#e74c3c' : '#3498db');
            setTimeout(() => { box.style.opacity = 0; }, 2500);
        }

        function fireworks() {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        console.log('ğŸ¦ è£è€€ç³»ç»Ÿ v7.0 å·²åŠ è½½');
    </script>
</body>
</html>

{
  "rules": {
    "families": {
      "$roomId": {
        ".read": true,
        ".write": true
      }
    }
  }
}
